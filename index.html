<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PEA Live 2.0 ‚Äî Dashboard Priv√©</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080b10;
    --surface: #0d1117;
    --surface2: #131920;
    --surface3: #1a2330;
    --border: #1e2d3d;
    --border2: #253545;
    --accent: #00d4ff;
    --accent2: #00ff9d;
    --accent3: #ff6b35;
    --warn: #ffd166;
    --danger: #ef233c;
    --text: #e2e8f0;
    --text2: #8fa3b8;
    --text3: #4a6279;
    --glow: rgba(0, 212, 255, 0.15);
    --glow2: rgba(0, 255, 157, 0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ NOISE TEXTURE OVERLAY ‚îÄ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  /* ‚îÄ‚îÄ‚îÄ SCAN LINE EFFECT ‚îÄ‚îÄ‚îÄ */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ‚îÄ */
  #lock-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    flex-direction: column;
    gap: 0;
  }

  .lock-container {
    width: 420px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 32px;
    border: 1px solid var(--border);
    background: var(--surface);
    position: relative;
    animation: lockAppear 0.6s ease;
    z-index: 1001;
}

  @keyframes lockAppear {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .lock-container::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .lock-logo {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.8;
  }

  .lock-title {
    font-size: 28px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 4px;
    line-height: 1.1;
  }

  .lock-title span { color: var(--accent); }

  .lock-sub {
    font-size: 13px;
    color: var(--text3);
    margin-bottom: 36px;
    font-family: 'Space Mono', monospace;
  }

  .lock-label {
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: block;
  }

  .lock-input-wrap {
    position: relative;
    margin-bottom: 16px;
  }

  .lock-input-wrap svg {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text3);
    width: 16px; height: 16px;
  }

  #api-url, #api-key {
    width: 100%;
    padding: 14px 14px 14px 42px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  #api-url:focus, #api-key:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--glow);
  }

  .lock-btn {
    width: 100%;
    padding: 15px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .lock-btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transform: translateX(-100%);
    transition: transform 0.4s;
  }

  .lock-btn:hover { background: #33ddff; }
  .lock-btn:hover::after { transform: translateX(100%); }
  .lock-btn:active { transform: scale(0.99); }

  #lock-error {
    margin-top: 12px;
    font-size: 12px;
    color: var(--danger);
    font-family: 'Space Mono', monospace;
    display: none;
    padding: 10px 12px;
    background: rgba(239, 35, 60, 0.08);
    border-left: 2px solid var(--danger);
  }

  .lock-hint {
    margin-top: 20px;
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    line-height: 1.7;
    border-top: 1px solid var(--border);
    padding-top: 16px;
  }

  .remember-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    margin-bottom: 4px;
  }

  .remember-row input[type="checkbox"] {
    accent-color: var(--accent);
    width: 14px;
    height: 14px;
    cursor: pointer;
  }

  .remember-row label {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    cursor: pointer;
    user-select: none;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
  #app {
    display: none;
    position: relative;
    z-index: 1;
    min-height: 100vh;
  }

  #app.visible { display: block; animation: fadeIn 0.5s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(8, 11, 16, 0.92);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
  }

  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand-icon {
    width: 32px; height: 32px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .brand-name {
    font-size: 15px;
    font-weight: 800;
    letter-spacing: 0.5px;
  }

  .brand-name span {
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .live-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--accent2);
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
  }

  .live-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent2);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  .last-update {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
  }

  .refresh-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 7px 14px;
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .logout-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text3);
    padding: 7px 14px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main {
    max-width: 1600px;
    margin: 0 auto;
    padding: 32px;
  }

  /* ‚îÄ‚îÄ‚îÄ HERO HEADER ‚îÄ‚îÄ‚îÄ */
  .hero {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 24px;
    margin-bottom: 32px;
    align-items: start;
  }

  .hero-left h1 {
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .portfolio-value {
    font-size: 56px;
    font-weight: 800;
    line-height: 1;
    color: var(--text);
    letter-spacing: -2px;
  }

  .portfolio-value .currency {
    font-size: 28px;
    color: var(--text3);
    font-weight: 400;
    margin-right: 4px;
  }

  .pv-row {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-top: 12px;
  }

  .pv-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    padding: 6px 12px;
    border: 1px solid;
  }

  .pv-chip.positive {
    color: var(--accent2);
    border-color: rgba(0, 255, 157, 0.3);
    background: rgba(0, 255, 157, 0.05);
  }

  .pv-chip.negative {
    color: var(--danger);
    border-color: rgba(239, 35, 60, 0.3);
    background: rgba(239, 35, 60, 0.05);
  }

  .hero-right {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 280px;
  }

  /* ‚îÄ‚îÄ‚îÄ HEALTH CARD ‚îÄ‚îÄ‚îÄ */
  .health-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px 24px;
    position: relative;
    overflow: hidden;
  }

  .health-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }

  .health-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .health-title {
    font-size: 11px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .health-score {
    font-family: 'Space Mono', monospace;
    font-size: 24px;
    font-weight: 700;
  }

  .health-label {
    font-size: 12px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .health-bar-track {
    height: 6px;
    background: var(--surface3);
    border-radius: 0;
    overflow: hidden;
  }

  .health-bar-fill {
    height: 100%;
    transition: width 1s ease;
    background: linear-gradient(90deg, var(--danger), var(--warn), var(--accent2));
  }

  .health-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 14px;
  }

  .health-item {
    background: var(--surface2);
    padding: 8px 10px;
  }

  .health-item-label {
    font-size: 10px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    margin-bottom: 3px;
  }

  .health-item-val {
    font-size: 13px;
    font-weight: 700;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
  }

  /* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px 22px;
    position: relative;
    transition: border-color 0.2s, transform 0.2s;
    cursor: default;
  }

  .stat-card:hover {
    border-color: var(--border2);
    transform: translateY(-1px);
  }

  .stat-card-label {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
    margin-bottom: 10px;
  }

  .stat-card-value {
    font-size: 22px;
    font-weight: 800;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    line-height: 1;
  }

  .stat-card-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 4px;
    font-family: 'Space Mono', monospace;
  }

  .stat-card .accent-line {
    position: absolute;
    bottom: 0; left: 0;
    height: 2px;
    width: 40%;
    background: var(--accent);
  }

  /* ‚îÄ‚îÄ‚îÄ GRID LAYOUT ‚îÄ‚îÄ‚îÄ */
  .grid-2-1 {
    display: grid;
    grid-template-columns: 1.7fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  .grid-1-1 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ‚îÄ */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .panel-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface2);
  }

  .panel-title {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
  }

  .panel-badge {
    font-size: 10px;
    padding: 3px 8px;
    background: var(--surface3);
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    border: 1px solid var(--border);
  }

  .panel-body {
    padding: 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ PORTFOLIO TABLE ‚îÄ‚îÄ‚îÄ */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid rgba(30, 45, 61, 0.5);
    transition: background 0.15s;
  }

  tbody tr:hover {
    background: var(--surface2);
  }

  tbody td {
    padding: 12px 12px;
    font-size: 13px;
    white-space: nowrap;
  }

  .ticker-cell {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    font-weight: 700;
  }

  .name-cell {
    color: var(--text2);
    font-size: 12px;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .num-cell {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    text-align: right;
  }

  .positive-text { color: var(--accent2); }
  .negative-text { color: var(--danger); }
  .neutral-text { color: var(--text3); }

  /* ‚îÄ‚îÄ‚îÄ SIGNAL BADGE ‚îÄ‚îÄ‚îÄ */
  .signal {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.5px;
    border: 1px solid;
    text-transform: uppercase;
    font-weight: 700;
  }

  .signal-buy { color: var(--accent2); border-color: rgba(0,255,157,0.3); background: rgba(0,255,157,0.06); }
  .signal-hold { color: var(--warn); border-color: rgba(255,209,102,0.3); background: rgba(255,209,102,0.06); }
  .signal-sell { color: var(--danger); border-color: rgba(239,35,60,0.3); background: rgba(239,35,60,0.06); }
  .signal-opportunity { color: var(--accent); border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.06); }
  .signal-neutral { color: var(--text3); border-color: var(--border); background: transparent; }

  /* ‚îÄ‚îÄ‚îÄ WEIGHT BAR ‚îÄ‚îÄ‚îÄ */
  .weight-bar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .weight-bar {
    height: 4px;
    background: var(--surface3);
    flex: 1;
    max-width: 60px;
    overflow: hidden;
  }

  .weight-bar-inner {
    height: 100%;
    background: var(--accent);
    transition: width 0.8s ease;
  }

  /* ‚îÄ‚îÄ‚îÄ CHART CONTAINERS ‚îÄ‚îÄ‚îÄ */
  .chart-wrap {
    position: relative;
    height: 280px;
  }

  .chart-wrap-sm {
    position: relative;
    height: 220px;
  }

  /* ‚îÄ‚îÄ‚îÄ SECTEUR TABLE ‚îÄ‚îÄ‚îÄ */
  .sector-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(30, 45, 61, 0.5);
  }

  .sector-color {
    width: 4px;
    height: 36px;
    flex-shrink: 0;
  }

  .sector-name {
    flex: 1;
    font-size: 13px;
    font-weight: 600;
  }

  .sector-poids {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--text2);
    width: 50px;
    text-align: right;
  }

  .sector-pv {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    width: 70px;
    text-align: right;
  }

  .sector-alert {
    font-size: 11px;
    padding: 2px 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    min-width: 80px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ‚îÄ HISTORIQUE CHART ‚îÄ‚îÄ‚îÄ */
  .historique-panel {
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    flex-direction: column;
    gap: 16px;
  }

  .spinner {
    width: 32px; height: 32px;
    border: 2px solid var(--surface3);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    letter-spacing: 2px;
  }

  /* ‚îÄ‚îÄ‚îÄ ALERT BANNER ‚îÄ‚îÄ‚îÄ */
  .alert-banner {
    padding: 14px 24px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    border-left: 3px solid;
    display: none;
  }

  .alert-banner.show { display: flex; }
  .alert-banner.warn { background: rgba(255,209,102,0.06); border-color: var(--warn); color: var(--warn); }
  .alert-banner.danger { background: rgba(239,35,60,0.06); border-color: var(--danger); color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ‚îÄ */
  .watchlist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(30,45,61,0.5);
    transition: background 0.15s;
  }

  .watchlist-item:hover { background: var(--surface2); }

  .wl-ticker {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--text3);
    width: 90px;
  }

  .wl-name {
    flex: 1;
    font-size: 12px;
    color: var(--text2);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .wl-status {
    font-size: 10px;
    padding: 2px 8px;
    border: 1px solid var(--border);
    color: var(--text3);
    font-family: 'Space Mono', monospace;
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 1200px) {
    .grid-2-1, .grid-1-1 { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .hero { grid-template-columns: 1fr; }
  }

  @media (max-width: 600px) {
    .main { padding: 16px; }
    .portfolio-value { font-size: 36px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .lock-container { width: calc(100vw - 32px); padding: 28px; }
  }

  /* ‚îÄ‚îÄ‚îÄ CUSTOM SCROLLBAR ‚îÄ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border2); }
  ::-webkit-scrollbar-thumb:hover { background: var(--text3); }

  /* Spinner in btn */
  .btn-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(8,11,16,0.3);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }
  .loading-btn .btn-text { display: none; }
  .loading-btn .btn-spinner { display: inline-block; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOCK SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lock-screen">
  <div class="lock-container">
    <div class="lock-logo">‚ñ∂ PEA LIVE SYSTEM</div>
    <h1 class="lock-title">Dashboard<br><span>Priv√©</span> 2.0</h1>
    <p class="lock-sub">// Acc√®s s√©curis√© requis</p>

    <label class="lock-label" for="api-url">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>
      URL Google Apps Script
    </label>
    <div class="lock-input-wrap" style="margin-bottom:16px">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>
      <input type="url" id="api-url" placeholder="https://script.google.com/macros/s/..." autocomplete="off">
    </div>

    <label class="lock-label" for="api-key">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 0 1 21.75 8.25Z" /></svg>
      Cl√© API / Token
    </label>
    <div class="lock-input-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 0 1 21.75 8.25Z" /></svg>
      <input type="password" id="api-key" placeholder="Votre cl√© secr√®te" autocomplete="off">
    </div>

    <button class="lock-btn" id="unlock-btn" onclick="handleUnlock()" type="button">
      <span class="btn-text">ACC√âDER AU DASHBOARD ‚Üí</span>
      <span class="btn-spinner"></span>
    </button>

    <div class="remember-row">
      <input type="checkbox" id="remember-me" checked>
      <label for="remember-me">M√©moriser mes identifiants sur cet appareil</label>
    </div>

    <div id="lock-error">‚ö† Connexion √©chou√©e ‚Äî V√©rifiez votre URL et votre cl√© API.</div>

    <div class="lock-hint">
      üí° L'URL doit √™tre celle de votre d√©ploiement Google Apps Script<br>
      La cl√© est pass√©e en param√®tre <code>?key=VOTRE_CLE</code>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-brand">
      <div class="brand-icon">üìä</div>
      <div>
        <div class="brand-name">PEA Live <span>2.0</span></div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="live-badge">
        <div class="live-dot"></div>
        LIVE
      </div>
      <div class="last-update" id="last-update-display">--</div>
      <button class="refresh-btn" onclick="refreshData()">
        ‚Ü∫ REFRESH
      </button>
      <button class="logout-btn" onclick="logout()">‚èª</button>
    </div>
  </header>

  <main class="main">

    <!-- ALERT BANNER -->
    <div class="alert-banner" id="alert-banner"></div>

    <!-- LOADING STATE -->
    <div class="loading" id="loading-state">
      <div class="spinner"></div>
      <div class="loading-text">CHARGEMENT DES DONN√âES...</div>
    </div>

    <!-- DASHBOARD CONTENT -->
    <div id="dashboard-content" style="display:none">

      <!-- HERO HEADER -->
      <div class="hero">
        <div class="hero-left">
          <h1>VALEUR TOTALE DU PORTEFEUILLE</h1>
          <div class="portfolio-value">
            <span class="currency">‚Ç¨</span><span id="total-value">--</span>
          </div>
          <div class="pv-row">
            <div class="pv-chip" id="pv-chip-eur">
              <span>‚ñ≤</span> <span id="pv-eur">--</span>
            </div>
            <div class="pv-chip" id="pv-chip-pct">
              <span>%</span> <span id="pv-pct">--</span>
            </div>
            <div style="font-size:12px; color: var(--text3); font-family:'Space Mono',monospace;" id="nb-lignes-display"></div>
          </div>
        </div>
        <div class="hero-right">
          <!-- HEALTH CARD -->
          <div class="health-card">
            <div class="health-header">
              <div class="health-title">üè• SANT√â PEA</div>
              <div class="health-score" id="health-score-display">--</div>
            </div>
            <div class="health-label" id="health-label">--</div>
            <div class="health-bar-track">
              <div class="health-bar-fill" id="health-bar" style="width:0%"></div>
            </div>
            <div class="health-details" id="health-details"></div>
          </div>
        </div>
      </div>

      <!-- STAT CARDS -->
      <div class="stats-row" id="stats-row">
        <div class="stat-card">
          <div class="stat-card-label">Positions actives</div>
          <div class="stat-card-value" id="stat-positions">--</div>
          <div class="stat-card-sub">titres en portefeuille</div>
          <div class="accent-line"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Meilleure position</div>
          <div class="stat-card-value" id="stat-best" style="font-size:16px;color:var(--accent2)">--</div>
          <div class="stat-card-sub" id="stat-best-pct">--</div>
          <div class="accent-line" style="background:var(--accent2)"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Moins-value max</div>
          <div class="stat-card-value" id="stat-worst" style="font-size:16px;color:var(--danger)">--</div>
          <div class="stat-card-sub" id="stat-worst-pct">--</div>
          <div class="accent-line" style="background:var(--danger)"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Secteurs</div>
          <div class="stat-card-value" id="stat-sectors">--</div>
          <div class="stat-card-sub">actifs dans le PEA</div>
          <div class="accent-line" style="background:var(--accent3)"></div>
        </div>
      </div>

      <!-- PORTFOLIO + SECTORS -->
      <div class="grid-2-1">
        <!-- PORTFOLIO TABLE -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <div class="dot"></div>
              PORTEFEUILLE
            </div>
            <span class="panel-badge" id="portfolio-count-badge">0 titres</span>
          </div>
          <div class="panel-body" style="padding:0">
            <div class="table-wrap">
              <table id="portfolio-table">
                <thead>
                  <tr>
                    <th>Ticker</th>
                    <th>Nom</th>
                    <th>Qt√©</th>
                    <th>PRU</th>
                    <th>Cours</th>
                    <th>Var. J</th>
                    <th>Valeur</th>
                    <th>PV‚Ç¨</th>
                    <th>PV%</th>
                    <th>Poids</th>
                    <th>Signal</th>
                  </tr>
                </thead>
                <tbody id="portfolio-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SECTORS PANEL -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <div class="dot" style="background:var(--accent3)"></div>
              SECTEURS
            </div>
          </div>
          <div class="panel-body">
            <div class="chart-wrap-sm">
              <canvas id="donut-chart"></canvas>
            </div>
            <div id="sector-list" style="margin-top:16px"></div>
          </div>
        </div>
      </div>

      <!-- HISTORIQUE -->
      <div class="panel historique-panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot" style="background:var(--accent2)"></div>
            HISTORIQUE DU PATRIMOINE
          </div>
          <span class="panel-badge" id="hist-count-badge">-- points</span>
        </div>
        <div class="panel-body">
          <div class="chart-wrap">
            <canvas id="history-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- WATCHLIST -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot" style="background:var(--warn)"></div>
            WATCHLIST ‚Äî En Surveillance
          </div>
        </div>
        <div class="panel-body" style="padding:0">
          <div id="watchlist-body"></div>
        </div>
      </div>

    </div><!-- /dashboard-content -->
  </main>
</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let API_URL = '';
let API_KEY = '';
let donutChart = null;
let historyChart = null;

const SECTOR_COLORS = [
  '#00d4ff', '#00ff9d', '#ff6b35', '#ffd166',
  '#a78bfa', '#fb7185', '#34d399', '#f97316',
  '#60a5fa', '#e879f9'
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function val(obj, ...keys) {
  for (const k of keys) {
    if (obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];
    const kNoSpace = k.replace(/\s/g, '');
    for (const ok of Object.keys(obj)) {
      if (ok.replace(/\s/g, '') === kNoSpace) {
        if (obj[ok] !== undefined && obj[ok] !== null && obj[ok] !== '') return obj[ok];
      }
    }
  }
  return undefined;
}

function numVal(obj, ...keys) {
  const v = val(obj, ...keys);
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function fmt(v, decimals = 2) {
  return Number(v).toLocaleString('fr-FR', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
}

function escH(str) {
  return String(str || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showAlert(type, msg) {
  const banner = document.getElementById('alert-banner');
  if (!banner) return;
  banner.className = 'alert-banner show ' + type;
  banner.textContent = msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH / LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  const savedUrl = localStorage.getItem('pea_api_url');
  const savedKey = localStorage.getItem('pea_api_key');

  const urlField = document.getElementById('api-url');
  const keyField = document.getElementById('api-key');

  if (savedUrl) urlField.value = savedUrl;
  else urlField.value = "https://script.google.com/macros/s/AKfycbwwh6nOe9RhFL_14q6rSd51XG9QlXgizxInrfvPxE4enYVp0nLxtSCn_S7_jiS2QkGD/exec";
  if (savedKey) keyField.value = savedKey;

  if (savedUrl && savedKey) {
    API_URL = savedUrl;
    API_KEY = savedKey;
    document.getElementById('lock-screen').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    fetchData();
  }

  urlField.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); keyField.focus(); }
  });
  keyField.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleUnlock();
  });
});

function handleUnlock() {
  let url = document.getElementById('api-url').value.trim();
  let key = document.getElementById('api-key').value.trim();

  if (!url) url = "https://script.google.com/macros/s/AKfycbwwh6nOe9RhFL_14q6rSd51XG9QlXgizxInrfvPxE4enYVp0nLxtSCn_S7_jiS2QkGD/exec";
  if (!key) { showAlert('danger', '‚ö† Veuillez saisir votre cl√© API.'); return; }

  API_URL = url;
  API_KEY = key;

  if (document.getElementById('remember-me') && document.getElementById('remember-me').checked) {
    localStorage.setItem('pea_api_url', url);
    localStorage.setItem('pea_api_key', key);
  }

  document.getElementById('lock-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  fetchData();
}

function logout() {
  localStorage.removeItem('pea_api_url');
  localStorage.removeItem('pea_api_key');
  API_URL = ''; API_KEY = '';
  document.getElementById('lock-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('dashboard-content').style.display = 'none';
  document.getElementById('loading-state').style.display = 'flex';
  if (donutChart) { donutChart.destroy(); donutChart = null; }
  if (historyChart) { historyChart.destroy(); historyChart = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FETCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchData() {
  document.getElementById('loading-state').style.display = 'flex';
  document.getElementById('dashboard-content').style.display = 'none';
  try {
    const resp = await fetch(`${API_URL}?key=${encodeURIComponent(API_KEY)}`, { redirect: 'follow' });
    const json = await resp.json();
    if (json.error) { showAlert('danger', '‚ö† Cl√© API invalide ‚Äî ' + json.error); return; }
    renderDashboard(json);
    document.getElementById('last-update-display').textContent =
      new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  } catch (err) {
    console.error('Fetch error:', err);
    showAlert('warn', '‚ö† Connexion impossible ‚Äî v√©rifiez votre r√©seau et l\'URL Apps Script.');
    document.getElementById('loading-state').style.display = 'none';
  }
}

function refreshData() { if (API_URL && API_KEY) fetchData(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(json) {
  const EXCLUS = ['TOTAL PORTEFEUILLE', 'TOTAL', 'Diagnostic Rapide', 'Score Sant√©'];
  const portfolio = (json['PORTFOLIO'] || []).filter(r => {
    const t = String(val(r, 'Ticker', 'ticker') || '').trim();
    if (!t) return false;
    if (EXCLUS.some(ex => t.includes(ex))) return false;
   // Exclure les lignes dont le ticker est purement num√©rique (ex: 45, 100...)
    if (/^\d+$/.test(t)) return false;
  // Exclure les lignes sans pr√©fixe boursier valide ET sans nom
    const nom = String(val(r, 'Nom', 'nom') || '').trim();
    if (!nom && !/^(EPA|ETR|NASDAQ|NYSE|AMS|BIT|SWX):/i.test(t)) return false;
    return numVal(r, 'Cours (‚Ç¨)', 'cours') > 0;
  });

  updateSummary(json, portfolio);
  renderTable(portfolio);
  renderCharts(json['Secteurs'] || [], json['Historique_Patrimoine'] || []);

  // Alerte surexposition
  const surexp = (json['Secteurs'] || []).filter(s =>
    String(val(s, '‚ö†Ô∏è Alerte') || '').includes('Surexpos√©')
  );
  if (surexp.length) {
    showAlert('danger', 'üî¥ SUREXPOSITION : ' + surexp.map(s =>
      val(s, 'Secteur') + ' (' + (numVal(s, 'Poids (%)') * 100).toFixed(1) + '%)'
    ).join(', '));
  }

  document.getElementById('loading-state').style.display = 'none';
  document.getElementById('dashboard-content').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPDATE SUMMARY (hero + stats + health)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSummary(json, portfolio) {
  // Totaux
  let totalValeur = 0, totalPV = 0;
  const ligneTotal = (json['PORTFOLIO'] || []).find(r =>
    String(r['Ticker'] || '').includes('TOTAL PORTEFEUILLE')
  );
  if (ligneTotal) {
    totalValeur = numVal(ligneTotal, 'Valeur (‚Ç¨)');
    totalPV     = numVal(ligneTotal, 'PV (‚Ç¨)');
  } else {
    portfolio.forEach(r => {
      totalValeur += numVal(r, 'Valeur (‚Ç¨)', 'valeur');
      totalPV     += numVal(r, 'PV (‚Ç¨)', 'pv');
    });
  }
  const isPos = totalPV >= 0;
  const pvPct = totalValeur > 0 ? (totalPV / (totalValeur - totalPV)) * 100 : 0;

  document.getElementById('total-value').textContent = fmt(totalValeur);
  document.getElementById('pv-eur').textContent = (isPos ? '+' : '') + fmt(totalPV) + ' ‚Ç¨';
  document.getElementById('pv-pct').textContent = (isPos ? '+' : '') + pvPct.toFixed(2) + '%';
  document.getElementById('pv-chip-eur').className = 'pv-chip ' + (isPos ? 'positive' : 'negative');
  document.getElementById('pv-chip-pct').className = 'pv-chip ' + (isPos ? 'positive' : 'negative');
  const pvChipEur = document.getElementById('pv-chip-eur');
  if (pvChipEur) pvChipEur.querySelector('span').textContent = isPos ? '‚ñ≤' : '‚ñº';
  const nbEl = document.getElementById('nb-lignes-display');
  if (nbEl) nbEl.textContent = portfolio.length + ' position' + (portfolio.length > 1 ? 's' : '') + ' active' + (portfolio.length > 1 ? 's' : '');

  // Stat cards
  document.getElementById('stat-positions').textContent = portfolio.length;
  let best = null, worst = null;
  portfolio.forEach(r => {
    const pct  = numVal(r, 'PV (%)', 'pv_pct');
    const name = String(val(r, 'Ticker', 'ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    if (pct !== 0) {
      if (!best || pct > best.pct) best = { name, pct };
      if (!worst || pct < worst.pct) worst = { name, pct };
    }
  });
  if (best) {
    document.getElementById('stat-best').textContent = best.name;
    document.getElementById('stat-best-pct').textContent = '+' + (best.pct * 100).toFixed(1) + '%';
  }
  if (worst) {
    document.getElementById('stat-worst').textContent = worst.name;
    document.getElementById('stat-worst-pct').textContent = (worst.pct * 100).toFixed(1) + '%';
  }
  const activeSectors = (json['Secteurs'] || []).filter(s => numVal(s, 'Valeur (‚Ç¨)') > 0);
  const statSectors = document.getElementById('stat-sectors');
  if (statSectors) statSectors.textContent = activeSectors.length;

  // Sant√©
  renderHealth(json['Sant√© PEA'] || [], portfolio);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HEALTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHealth(sante, portfolio) {
  const score = computeHealthScore(portfolio);
  const scoreColor = score >= 75 ? 'var(--accent2)' : score >= 50 ? 'var(--warn)' : 'var(--danger)';
  const scoreEl = document.getElementById('health-score-display');
  if (scoreEl) { scoreEl.textContent = score + '/100'; scoreEl.style.color = scoreColor; }
  const labelEl = document.getElementById('health-label');
  if (labelEl) { labelEl.textContent = getHealthLabel(score); labelEl.style.color = scoreColor; }
  setTimeout(() => {
    const bar = document.getElementById('health-bar');
    if (bar) bar.style.width = score + '%';
  }, 300);

  const maxPoids = portfolio.reduce((m, p) => Math.max(m, numVal(p, 'Poids(%)', 'Poids (%)')), 0);
  const withMarge = portfolio.filter(p => {
    const m = val(p, 'Marge de S√©curit√© (%)');
    return m != null && m !== '' && m !== '--';
  });
  const avgMarge = withMarge.length
    ? withMarge.reduce((a, p) => a + numVal(p, 'Marge de S√©curit√© (%)'), 0) / withMarge.length
    : 0;
  const nbActif = portfolio.filter(p => numVal(p, 'Valeur (‚Ç¨)', 'valeur') > 0).length;

  const div = document.getElementById('health-details');
  if (div) div.innerHTML = `
    <div class="health-item"><div class="health-item-label">LIGNES ACTIVES</div><div class="health-item-val">${nbActif}</div></div>
    <div class="health-item"><div class="health-item-label">MAX CONCENTRATION</div><div class="health-item-val" style="color:${maxPoids > 0.35 ? 'var(--danger)' : 'var(--accent)'}">${(maxPoids * 100).toFixed(1)}%</div></div>
    <div class="health-item"><div class="health-item-label">MARGE S√âCU MOY.</div><div class="health-item-val">${(avgMarge * 100).toFixed(1)}%</div></div>
    <div class="health-item"><div class="health-item-label">SCORE</div><div class="health-item-val" style="color:${scoreColor}">${score} pts</div></div>
  `;
}

function computeHealthScore(portfolio) {
  let score = 0;
  const n = portfolio.filter(p => numVal(p, 'Valeur (‚Ç¨)', 'valeur') > 0).length;
  if (n >= 5) score += 25; else if (n === 4) score += 18; else if (n === 3) score += 10;
  const rouge = portfolio.filter(p => numVal(p, 'Poids(%)', 'Poids (%)') > 0.2).length;
  if (rouge === 0) score += 25; else if (rouge === 1) score += 12;
  const withMarge = portfolio.filter(p => { const m = val(p, 'Marge de S√©curit√© (%)'); return m != null && m !== '' && m !== '--'; });
  const avgMarge = withMarge.length ? withMarge.reduce((a, p) => a + numVal(p, 'Marge de S√©curit√© (%)'), 0) / withMarge.length : 0;
  if (avgMarge > 0.2) score += 25; else if (avgMarge > 0.1) score += 18; else if (avgMarge > 0) score += 10;
  const maxPoids = portfolio.reduce((m, p) => Math.max(m, numVal(p, 'Poids(%)', 'Poids (%)')), 0);
  if (maxPoids < 0.25) score += 25; else if (maxPoids < 0.3) score += 18; else if (maxPoids < 0.35) score += 10; else if (maxPoids < 0.4) score += 5;
  return Math.min(100, score);
}

function getHealthLabel(score) {
  if (score >= 80) return 'üü¢ Portefeuille SOLIDE';
  if (score >= 65) return 'üü° Portefeuille CORRECT';
  if (score >= 50) return 'üü† Portefeuille FRAGILE';
  return 'üî¥ Portefeuille √Ä RISQUE';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABLE PORTFOLIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable(portfolio) {
  const badge = document.getElementById('portfolio-count-badge');
  const tbody = document.getElementById('portfolio-tbody');
  if (!tbody) return;

  // S√©parer actifs et watchlist selon QT√â
  const actifs    = portfolio.filter(r => numVal(r, 'Quantit√©', 'quantite') > 0);
  const watchlist = portfolio.filter(r => numVal(r, 'Quantit√©', 'quantite') === 0);

  if (badge) badge.textContent = actifs.length + ' actifs ¬∑ ' + watchlist.length + ' en veille';

  actifs.sort((a, b) => numVal(b, 'Valeur (‚Ç¨)', 'valeur') - numVal(a, 'Valeur (‚Ç¨)', 'valeur'));

  tbody.innerHTML = '';

  // ‚îÄ‚îÄ BLOC 1 : positions actives ‚îÄ‚îÄ
  actifs.forEach(r => appendRow(tbody, r, false));

  // ‚îÄ‚îÄ S√âPARATEUR ‚îÄ‚îÄ
  if (watchlist.length > 0) {
    const sep = document.createElement('tr');
    sep.innerHTML = `
      <td colspan="11" style="
        padding: 8px 12px;
        font-size: 10px;
        letter-spacing: 2px;
        color: var(--text3);
        font-family: 'Space Mono', monospace;
        background: var(--surface2);
        border-top: 2px solid var(--border);
        border-bottom: 1px solid var(--border);
      ">‚Äî WATCHLIST ¬∑ EN SURVEILLANCE</td>
    `;
    tbody.appendChild(sep);
  }

  // ‚îÄ‚îÄ BLOC 2 : watchlist ‚îÄ‚îÄ
  watchlist.forEach(r => appendRow(tbody, r, true));
}

function appendRow(tbody, r, isWatchlist) {
  const pv      = numVal(r, 'PV (‚Ç¨)', 'pv');
  const pvPct   = numVal(r, 'PV (%)', 'pv_pct') * 100;
  const varJour = numVal(r, 'Var. Jour', 'var_jour') * 100;
  const poids   = numVal(r, 'Poids(%)', 'Poids (%)', 'poids') * 100;
  const signal  = String(val(r, 'Signal', 'signal') || '--');
  const ticker  = String(val(r, 'Ticker', 'ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
  const nom     = String(val(r, 'Nom', 'nom') || '');
  const qte     = numVal(r, 'Quantit√©', 'quantite');
  const pru     = numVal(r, 'PRU (‚Ç¨)', 'pru');
  const cours   = numVal(r, 'Cours (‚Ç¨)', 'cours');
  const valeur  = numVal(r, 'Valeur (‚Ç¨)', 'valeur');

  const pvClass  = pv >= 0 ? 'positive-text' : 'negative-text';
  const varClass = varJour >= 0 ? 'positive-text' : 'negative-text';
  const tickColor = isWatchlist ? 'color:var(--text3)' : '';

  const dash = '<span style="color:var(--text3)">‚Äî</span>';

  const tr = document.createElement('tr');
  if (isWatchlist) tr.style.cssText = 'opacity:0.45;';

  tr.innerHTML = `
    <td><span class="ticker-cell" style="${tickColor}">${escH(ticker)}</span></td>
    <td><span class="name-cell" title="${escH(nom)}">${escH(nom.substring(0,25))}${nom.length>25?'‚Ä¶':''}</span></td>
    <td class="num-cell">${isWatchlist ? dash : fmt(qte, 0)}</td>
    <td class="num-cell">${isWatchlist ? dash : fmt(pru) + ' ‚Ç¨'}</td>
    <td class="num-cell">${fmt(cours)} ‚Ç¨</td>
    <td class="num-cell ${varClass}">${varJour >= 0 ? '+' : ''}${varJour.toFixed(2)}%</td>
    <td class="num-cell">${isWatchlist ? dash : fmt(valeur) + ' ‚Ç¨'}</td>
    <td class="num-cell">${isWatchlist ? dash : (pv >= 0 ? '+' : '') + fmt(pv) + ' ‚Ç¨'}</td>
    <td class="num-cell">${isWatchlist ? dash : (pvPct >= 0 ? '+' : '') + pvPct.toFixed(2) + '%'}</td>
    <td>
      ${isWatchlist
        ? '<span style="color:var(--text3);font-size:10px;font-family:\'Space Mono\',monospace;letter-spacing:1px">VEILLE</span>'
        : `<div class="weight-bar-wrap">
            <div class="weight-bar"><div class="weight-bar-inner" style="width:${Math.min(poids*2,100)}%"></div></div>
            <span style="font-size:10px;font-family:'Space Mono',monospace;color:var(--text3)">${poids.toFixed(1)}%</span>
           </div>`
      }
    </td>
    <td>${renderSignal(signal)}</td>
  `;
  tbody.appendChild(tr);
}

function renderSignal(signal) {
  const s = (signal || '').toLowerCase();
  let cls = 'signal-neutral', icon = '‚ó¶';
  if (s.includes('fort achat'))        { cls = 'signal-buy';         icon = '‚ñ≤‚ñ≤'; }
  else if (s.includes('achat') || s.includes('buy')) { cls = 'signal-buy'; icon = '‚ñ≤'; }
  else if (s.includes('vente') || s.includes('sell')) { cls = 'signal-sell'; icon = '‚ñº'; }
  else if (s.includes('conserver') || s.includes('hold') || s.includes('neutre')) { cls = 'signal-hold'; icon = '‚óÜ'; }
  else if (s.includes('opportunit'))   { cls = 'signal-opportunity'; icon = '‚óà'; }
  else if (signal === '--')            return `<span class="signal signal-neutral">‚Äî</span>`;
  return `<span class="signal ${cls}">${icon} ${escH(signal)}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts(secteurs, historique) {
  renderDonut(secteurs);
  renderHistorique(historique);
}

function renderDonut(secteurs) {
  const active = secteurs.filter(s => numVal(s, 'Valeur (‚Ç¨)') > 0 && String(val(s,'Secteur') || '') !== 'TOTAL');
  const labels = active.map(s => String(val(s, 'Secteur') || ''));
  const values = active.map(s => numVal(s, 'Valeur (‚Ç¨)'));

  if (donutChart) { donutChart.destroy(); donutChart = null; }
  const canvas = document.getElementById('donut-chart');
  if (!canvas) return;

  donutChart = new Chart(canvas.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: SECTOR_COLORS.slice(0, labels.length).map(c => c + 'cc'),
        borderColor: SECTOR_COLORS.slice(0, labels.length),
        borderWidth: 1,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117', borderColor: '#1e2d3d', borderWidth: 1,
          titleFont: { family: 'Space Mono' }, bodyFont: { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0', titleColor: '#00d4ff',
          callbacks: { label: ctx => ` ${ctx.label}: ${fmt(ctx.parsed)} ‚Ç¨ (${(ctx.parsed / values.reduce((a,b)=>a+b,0)*100).toFixed(1)}%)` }
        }
      }
    }
  });

  // Liste sectorielle
  const listEl = document.getElementById('sector-list');
  if (!listEl) return;
  listEl.innerHTML = '';
  active.forEach((s, i) => {
    const pv    = numVal(s, 'PV (‚Ç¨)');
    const poids = numVal(s, 'Poids (%)') * 100;
    const alert = String(val(s, '‚ö†Ô∏è Alerte') || '');
    const alertColor = alert.includes('Surexpos√©') ? 'var(--danger)' : alert.includes('Surveiller') ? 'var(--warn)' : 'var(--accent2)';
    const div = document.createElement('div');
    div.className = 'sector-row';
    div.innerHTML = `
      <div class="sector-color" style="background:${SECTOR_COLORS[i] || '#888'}"></div>
      <div class="sector-name">${escH(String(val(s,'Secteur') || ''))}</div>
      <div class="sector-poids">${poids.toFixed(1)}%</div>
      <div class="sector-pv ${pv >= 0 ? 'positive-text' : 'negative-text'}">${pv >= 0 ? '+' : ''}${fmt(pv)} ‚Ç¨</div>
      <div class="sector-alert" style="color:${alertColor};border-color:${alertColor}33">${escH(alert)}</div>
    `;
    listEl.appendChild(div);
  });
}

function renderHistorique(historique) {
  const badge = document.getElementById('hist-count-badge');
  const pts = historique
    .filter(r => (r['üìÖ Date'] || r['Date']) && (r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0) > 0)
    .map(r => ({
      date: new Date(r['üìÖ Date'] || r['Date']),
      val: parseFloat(r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0)
    }))
    .sort((a, b) => a.date - b.date);

  if (badge) badge.textContent = pts.length + ' points';
  if (historyChart) { historyChart.destroy(); historyChart = null; }
  const canvas = document.getElementById('history-chart');
  if (!canvas || pts.length === 0) return;

  const ctx = canvas.getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(0,212,255,0.2)');
  gradient.addColorStop(1, 'rgba(0,212,255,0)');

  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: pts.map(p => p.date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })),
      datasets: [{
        label: 'Valeur (‚Ç¨)', data: pts.map(p => p.val),
        borderColor: '#00d4ff', backgroundColor: gradient,
        borderWidth: 2, pointRadius: pts.length > 20 ? 0 : 3,
        tension: 0.4, fill: true
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117', borderColor: '#1e2d3d', borderWidth: 1,
          titleFont: { family: 'Space Mono', size: 11 },
          bodyFont: { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0', titleColor: '#00d4ff',
          callbacks: { label: ctx => ` ${fmt(ctx.parsed.y)} ‚Ç¨` }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(30,45,61,0.5)' }, ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, maxTicksLimit: 8 } },
        y: { grid: { color: 'rgba(30,45,61,0.5)' }, ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, callback: v => fmt(v) + ' ‚Ç¨' } }
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WATCHLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWatchlist(watchlist) {
  const div = document.getElementById('watchlist-body');
  if (!div) return;
  if (!watchlist.length) {
    div.innerHTML = '<div style="padding:24px;color:var(--text3);font-size:13px;font-family:\'Space Mono\',monospace;">Aucune valeur en watchlist.</div>';
    return;
  }
  div.innerHTML = '';
  watchlist.forEach(r => {
    const ticker  = String(r['Indicateur'] || '--');
    const secteur = String(r['Valeur'] || '');
    const poids   = r['Max'] ? (parseFloat(r['Max']) * 100).toFixed(0) + '% max' : '';
    const statut  = '‚Äî Watchlist';
    const nom     = '';
    const d = document.createElement('div');
    d.className = 'watchlist-item';
    d.innerHTML = `
      <div class="wl-ticker">${escH(ticker)}</div>
      <div class="wl-name">${escH(nom)}</div>
      <div class="wl-status">${escH(secteur)}</div>
      <div class="wl-status">${escH(statut)}</div>
    `;
    div.appendChild(d);
  });
}
</script>
</body>
</html>
