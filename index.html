<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PEA Live 2.0 ‚Äî Dashboard Priv√©</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080b10;
    --surface: #0d1117;
    --surface2: #131920;
    --surface3: #1a2330;
    --border: #1e2d3d;
    --border2: #253545;
    --accent: #00d4ff;
    --accent2: #00ff9d;
    --accent3: #ff6b35;
    --warn: #ffd166;
    --danger: #ef233c;
    --text: #e2e8f0;
    --text2: #8fa3b8;
    --text3: #4a6279;
    --glow: rgba(0, 212, 255, 0.15);
    --glow2: rgba(0, 255, 157, 0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ‚îÄ NOISE TEXTURE OVERLAY ‚îÄ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  /* ‚îÄ‚îÄ‚îÄ SCAN LINE EFFECT ‚îÄ‚îÄ‚îÄ */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ‚îÄ */
  #lock-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    flex-direction: column;
    gap: 0;
  }

  .lock-container {
    width: 420px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 32px;
    border: 1px solid var(--border);
    background: var(--surface);
    position: relative;
    animation: lockAppear 0.6s ease;
    z-index: 1001;
}

  @keyframes lockAppear {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .lock-container::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .lock-logo {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 8px;
    opacity: 0.8;
  }

  .lock-title {
    font-size: 28px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 4px;
    line-height: 1.1;
  }

  .lock-title span { color: var(--accent); }

  .lock-sub {
    font-size: 13px;
    color: var(--text3);
    margin-bottom: 36px;
    font-family: 'Space Mono', monospace;
  }

  .lock-label {
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: block;
  }

  .lock-input-wrap {
    position: relative;
    margin-bottom: 16px;
  }

  .lock-input-wrap svg {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text3);
    width: 16px; height: 16px;
  }

  #api-url, #api-key {
    width: 100%;
    padding: 14px 14px 14px 42px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  #api-url:focus, #api-key:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--glow);
  }

  .lock-btn {
    width: 100%;
    padding: 15px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .lock-btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transform: translateX(-100%);
    transition: transform 0.4s;
  }

  .lock-btn:hover { background: #33ddff; }
  .lock-btn:hover::after { transform: translateX(100%); }
  .lock-btn:active { transform: scale(0.99); }

  #lock-error {
    margin-top: 12px;
    font-size: 12px;
    color: var(--danger);
    font-family: 'Space Mono', monospace;
    display: none;
    padding: 10px 12px;
    background: rgba(239, 35, 60, 0.08);
    border-left: 2px solid var(--danger);
  }

  .lock-hint {
    margin-top: 20px;
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    line-height: 1.7;
    border-top: 1px solid var(--border);
    padding-top: 16px;
  }

  .remember-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    margin-bottom: 4px;
  }

  .remember-row input[type="checkbox"] {
    accent-color: var(--accent);
    width: 14px;
    height: 14px;
    cursor: pointer;
  }

  .remember-row label {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    cursor: pointer;
    user-select: none;
  }

  /* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
  #app {
    display: none;
    position: relative;
    z-index: 1;
    min-height: 100vh;
  }

  #app.visible { display: block; animation: fadeIn 0.5s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
  .topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(8, 11, 16, 0.92);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 60px;
  }

  .topbar-brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand-icon {
    width: 32px; height: 32px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .brand-name {
    font-size: 15px;
    font-weight: 800;
    letter-spacing: 0.5px;
  }

  .brand-name span {
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .live-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--accent2);
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
  }

  .live-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent2);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  .last-update {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
  }

  .refresh-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 7px 14px;
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .refresh-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .logout-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text3);
    padding: 7px 14px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main {
    max-width: 1600px;
    margin: 0 auto;
    padding: 32px;
  }

  /* ‚îÄ‚îÄ‚îÄ HERO HEADER ‚îÄ‚îÄ‚îÄ */
  .hero {
    display: grid;
    grid-template-columns: 1fr 120px auto;
    gap: 24px;
    margin-bottom: 32px;
    align-items: center;
  }

  .hero-left h1 {
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .portfolio-value {
    font-size: 56px;
    font-weight: 800;
    line-height: 1;
    color: var(--text);
    letter-spacing: -2px;
  }

  .portfolio-value .currency {
    font-size: 28px;
    color: var(--text3);
    font-weight: 400;
    margin-right: 4px;
  }

  .pv-row {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-top: 12px;
  }

  .pv-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    padding: 6px 12px;
    border: 1px solid;
  }

  .pv-chip.positive {
    color: var(--accent2);
    border-color: rgba(0, 255, 157, 0.3);
    background: rgba(0, 255, 157, 0.05);
  }

  .pv-chip.negative {
    color: var(--danger);
    border-color: rgba(239, 35, 60, 0.3);
    background: rgba(239, 35, 60, 0.05);
  }

  .hero-right {
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-width: 280px;
  }


  /* ‚îÄ‚îÄ‚îÄ HUD BIOMETRIC SCAN ‚îÄ‚îÄ‚îÄ */
  .kpi-visual-bridge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 120px;
    height: 120px;
    flex-shrink: 0;
  }

  .hud-svg {
    width: 120px;
    height: 120px;
    overflow: visible;
  }

  .hud-outer-ring {
    transform-origin: 0 0;
    animation: hud-rotate-cw 12s linear infinite;
  }

  .hud-inner-ring {
    transform-origin: 0 0;
    animation: hud-rotate-ccw 8s linear infinite;
  }

  .hud-scan-arc {
    transform-origin: 0 0;
    animation: hud-rotate-cw 3s linear infinite;
  }

  .hud-pulse {
    animation: hud-pulse 2s ease-in-out infinite;
  }

  .hud-pulse-text {
    animation: hud-pulse-text 2s ease-in-out infinite;
  }

  @keyframes hud-rotate-cw {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  @keyframes hud-rotate-ccw {
    from { transform: rotate(0deg); }
    to   { transform: rotate(-360deg); }
  }

  @keyframes hud-pulse {
    0%, 100% { opacity: 0.6; r: 3; }
    50%       { opacity: 1;   r: 4; }
  }

  @keyframes hud-pulse-text {
    0%, 100% { opacity: 0.7; }
    50%       { opacity: 1;   }
  }

  /* ‚îÄ‚îÄ‚îÄ HEALTH CARD ‚îÄ‚îÄ‚îÄ */
  .health-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px 24px;
    position: relative;
    overflow: hidden;
  }

  .health-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }

  .health-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .health-title {
    font-size: 11px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .health-score {
    font-family: 'Space Mono', monospace;
    font-size: 24px;
    font-weight: 700;
  }

  .health-label {
    font-size: 12px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .health-bar-track {
    height: 6px;
    background: var(--surface3);
    border-radius: 0;
    overflow: hidden;
  }

  .health-bar-fill {
    height: 100%;
    transition: width 1s ease;
    background: linear-gradient(90deg, var(--danger), var(--warn), var(--accent2));
  }

  .health-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 14px;
  }

  .health-item {
    background: var(--surface2);
    padding: 8px 10px;
  }

  .health-item-label {
    font-size: 10px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    margin-bottom: 3px;
  }

  .health-item-val {
    font-size: 13px;
    font-weight: 700;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
  }

  /* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px 22px;
    position: relative;
    transition: border-color 0.2s, transform 0.2s;
    cursor: default;
  }

  .stat-card:hover {
    border-color: var(--border2);
    transform: translateY(-1px);
  }

  .stat-card-label {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
    margin-bottom: 10px;
  }

  .stat-card-value {
    font-size: 22px;
    font-weight: 800;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    line-height: 1;
  }

  .stat-card-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 4px;
    font-family: 'Space Mono', monospace;
  }

  .stat-card .accent-line {
    position: absolute;
    bottom: 0; left: 0;
    height: 2px;
    width: 40%;
    background: var(--accent);
  }

  /* ‚îÄ‚îÄ‚îÄ GRID LAYOUT ‚îÄ‚îÄ‚îÄ */
  .grid-2-1 {
    display: grid;
    grid-template-columns: 1.7fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  .grid-1-1 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ‚îÄ */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .panel-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface2);
  }

  .panel-title {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
  }

  .panel-badge {
    font-size: 10px;
    padding: 3px 8px;
    background: var(--surface3);
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    border: 1px solid var(--border);
  }

  .panel-body {
    padding: 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ PORTFOLIO TABLE ‚îÄ‚îÄ‚îÄ */
  .table-wrap {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    font-size: 10px;
    color: var(--text3);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid rgba(30, 45, 61, 0.5);
    transition: background 0.15s;
  }

  tbody tr:hover {
    background: var(--surface2);
  }

  tbody td {
    padding: 12px 12px;
    font-size: 13px;
    white-space: nowrap;
  }

  .ticker-cell {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    font-weight: 700;
  }

  .name-cell {
    color: var(--text2);
    font-size: 12px;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .num-cell {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    text-align: right;
  }

  .positive-text { color: var(--accent2); }
  .negative-text { color: var(--danger); }
  .neutral-text { color: var(--text3); }

  /* ‚îÄ‚îÄ‚îÄ SIGNAL BADGE ‚îÄ‚îÄ‚îÄ */
  .signal {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.5px;
    border: 1px solid;
    text-transform: uppercase;
    font-weight: 700;
  }

  .signal-buy { color: var(--accent2); border-color: rgba(0,255,157,0.3); background: rgba(0,255,157,0.06); }
  .signal-hold { color: var(--warn); border-color: rgba(255,209,102,0.3); background: rgba(255,209,102,0.06); }
  .signal-sell { color: var(--danger); border-color: rgba(239,35,60,0.3); background: rgba(239,35,60,0.06); }
  .signal-opportunity { color: var(--accent); border-color: rgba(0,212,255,0.3); background: rgba(0,212,255,0.06); }
  .signal-neutral { color: var(--text3); border-color: var(--border); background: transparent; }

  /* ‚îÄ‚îÄ‚îÄ WEIGHT BAR ‚îÄ‚îÄ‚îÄ */
  .weight-bar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .weight-bar {
    height: 4px;
    background: var(--surface3);
    flex: 1;
    max-width: 60px;
    overflow: hidden;
  }

  .weight-bar-inner {
    height: 100%;
    background: var(--accent);
    transition: width 0.8s ease;
  }

  /* ‚îÄ‚îÄ‚îÄ CHART CONTAINERS ‚îÄ‚îÄ‚îÄ */
  .chart-wrap {
    position: relative;
    height: 280px;
  }

  .chart-wrap-sm {
    position: relative;
    height: 220px;
  }

  /* ‚îÄ‚îÄ‚îÄ SECTEUR TABLE ‚îÄ‚îÄ‚îÄ */
  .sector-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(30, 45, 61, 0.5);
  }

  .sector-color {
    width: 4px;
    height: 36px;
    flex-shrink: 0;
  }

  .sector-name {
    flex: 1;
    font-size: 13px;
    font-weight: 600;
  }

  .sector-poids {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--text2);
    width: 50px;
    text-align: right;
  }

  .sector-pv {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    width: 70px;
    text-align: right;
  }

  .sector-alert {
    font-size: 11px;
    padding: 2px 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    min-width: 80px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ‚îÄ HISTORIQUE CHART ‚îÄ‚îÄ‚îÄ */
  .historique-panel {
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    flex-direction: column;
    gap: 16px;
  }

  .spinner {
    width: 32px; height: 32px;
    border: 2px solid var(--surface3);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    letter-spacing: 2px;
  }

  /* ‚îÄ‚îÄ‚îÄ ALERT BANNER ‚îÄ‚îÄ‚îÄ */
  .alert-banner {
    padding: 14px 24px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    border-left: 3px solid;
    display: none;
  }

  .alert-banner.show { display: flex; }
  .alert-banner.warn { background: rgba(255,209,102,0.06); border-color: var(--warn); color: var(--warn); }
  .alert-banner.danger { background: rgba(239,35,60,0.06); border-color: var(--danger); color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ‚îÄ */
  .watchlist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(30,45,61,0.5);
    transition: background 0.15s;
  }

  .watchlist-item:hover { background: var(--surface2); }

  .wl-ticker {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--text3);
    width: 90px;
  }

  .wl-name {
    flex: 1;
    font-size: 12px;
    color: var(--text2);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .wl-status {
    font-size: 10px;
    padding: 2px 8px;
    border: 1px solid var(--border);
    color: var(--text3);
    font-family: 'Space Mono', monospace;
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 1200px) {
    .grid-2-1, .grid-1-1 { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .hero { grid-template-columns: 1fr; }
  }

  @media (max-width: 600px) {
    .main { padding: 16px; }
    .portfolio-value { font-size: 36px; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .lock-container { width: calc(100vw - 32px); padding: 28px; }
  }

  /* ‚îÄ‚îÄ‚îÄ CUSTOM SCROLLBAR ‚îÄ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border2); }
  ::-webkit-scrollbar-thumb:hover { background: var(--text3); }

  /* Spinner in btn */
  .btn-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(8,11,16,0.3);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: none;
  }
  .loading-btn .btn-text { display: none; }
  .loading-btn .btn-spinner { display: inline-block; }

  /* ‚îÄ‚îÄ‚îÄ TAB NAVIGATION ‚îÄ‚îÄ‚îÄ */
  .tab-nav {
    display: flex;
    gap: 0;
    margin-bottom: 28px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }

  .tab-btn {
    background: transparent;
    border: none;
    padding: 12px 24px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text3);
    cursor: pointer;
    position: relative;
    transition: color 0.2s;
  }

  .tab-btn::after {
    content: '';
    position: absolute;
    bottom: -1px; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
    transform: scaleX(0);
    transition: transform 0.25s ease;
    box-shadow: 0 0 8px var(--accent);
  }

  .tab-btn:hover { color: var(--text2); }
  .tab-btn.active { color: var(--accent); }
  .tab-btn.active::after { transform: scaleX(1); }

  .tab-view { display: none; }
  .tab-view.active { display: block; animation: fadeIn 0.3s ease; }

  /* ‚îÄ‚îÄ‚îÄ PERF VIEW ‚Äî STICKY HEADER ‚îÄ‚îÄ‚îÄ */
  .perf-sticky-header {
    position: sticky;
    top: 60px;
    z-index: 50;
    background: rgba(8, 11, 16, 0.96);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    border-top: none;
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 32px;
    margin-bottom: 24px;
  }

  .perf-sticky-kpi { display: flex; flex-direction: column; gap: 2px; }

  .perf-sticky-label {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 2px;
    color: var(--text3);
    text-transform: uppercase;
  }

  .perf-sticky-val {
    font-family: 'Space Mono', monospace;
    font-size: 15px;
    font-weight: 700;
  }

  .perf-sticky-divider { width: 1px; height: 32px; background: var(--border); }

  /* ‚îÄ‚îÄ‚îÄ CONTRIB CELL ‚îÄ‚îÄ‚îÄ */
  .contrib-cell {
    position: relative;
    min-width: 140px;
  }

  .contrib-bar-bg {
    position: absolute;
    top: 2px; bottom: 2px; left: 0;
    transition: width 0.8s ease;
    pointer-events: none;
    opacity: 0.12;
  }

  .contrib-val {
    position: relative;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    text-align: right;
    z-index: 1;
  }

  /* ‚îÄ‚îÄ‚îÄ SPARKLINES ‚îÄ‚îÄ‚îÄ */
  .sparkline-cell { min-width: 80px; }
  .sparkline-cell svg { display: block; }

  /* ‚îÄ‚îÄ‚îÄ TIMEFRAME SELECTOR ‚îÄ‚îÄ‚îÄ */
  .timeframe-row { display: flex; gap: 6px; align-items: center; }

  .tf-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    padding: 5px 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tf-btn:hover { border-color: var(--accent); color: var(--accent); }

  .tf-btn.active {
    background: rgba(0, 212, 255, 0.1);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 6px rgba(0,212,255,0.2);
  }

  .equity-chart-wrap { position: relative; height: 380px; }

  .ath-line-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--warn);
    letter-spacing: 1px;
  }

  .drawdown-badge {
    background: rgba(239, 35, 60, 0.1);
    border: 1px solid rgba(239, 35, 60, 0.3);
    color: var(--danger);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 4px 10px;
  }

  .ath-badge {
    background: rgba(255, 209, 102, 0.08);
    border: 1px solid rgba(255, 209, 102, 0.3);
    color: var(--warn);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 4px 10px;
  }

  /* ‚îÄ‚îÄ‚îÄ CATEGORY FILTER BUTTONS ‚îÄ‚îÄ‚îÄ */
  .cat-filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    align-items: center;
  }

  .cat-filter-label {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-right: 4px;
  }

  .cat-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    letter-spacing: 1.5px;
    padding: 6px 14px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .cat-btn:hover { border-color: var(--accent); color: var(--accent); }

  .cat-btn.active {
    background: rgba(0, 212, 255, 0.08);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 8px rgba(0, 212, 255, 0.15);
  }

  .cat-btn.etf.active {
    background: rgba(255, 209, 102, 0.08);
    border-color: var(--warn);
    color: var(--warn);
    box-shadow: 0 0 8px rgba(255, 209, 102, 0.15);
  }

  /* ‚îÄ‚îÄ‚îÄ HEALTH SCORE CARDS ‚îÄ‚îÄ‚îÄ */
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .health-score-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 18px 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.15s;
    cursor: default;
  }

  .health-score-card:hover {
    border-color: var(--border2);
    transform: translateY(-1px);
  }

  .health-score-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 3px;
    height: 100%;
  }

  .health-score-card.etf-card::before { background: var(--warn); }
  .health-score-card.action-card::before { background: var(--accent); }

  .hsc-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .hsc-ticker {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--accent);
  }

  .hsc-name {
    font-size: 11px;
    color: var(--text3);
    margin-top: 2px;
    font-family: 'Space Mono', monospace;
  }

  .hsc-badge {
    font-size: 9px;
    padding: 3px 8px;
    border: 1px solid;
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
    text-transform: uppercase;
    font-weight: 700;
  }

  .badge-shield {
    color: var(--warn);
    border-color: rgba(255, 209, 102, 0.4);
    background: rgba(255, 209, 102, 0.06);
  }

  .badge-action {
    color: var(--accent);
    border-color: rgba(0, 212, 255, 0.4);
    background: rgba(0, 212, 255, 0.06);
  }

  .hsc-score-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }

  .hsc-score-num {
    font-size: 32px;
    font-weight: 800;
    font-family: 'Syne', sans-serif;
    line-height: 1;
  }

  .hsc-score-label {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
  }

  .hsc-bar-track {
    height: 4px;
    background: var(--surface3);
    overflow: hidden;
    margin-bottom: 10px;
  }

  .hsc-bar-fill {
    height: 100%;
    transition: width 1s ease;
  }

  .hsc-meta {
    display: flex;
    gap: 16px;
  }

  .hsc-meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .hsc-meta-label {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .hsc-meta-val {
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
  }

  /* ‚îÄ‚îÄ‚îÄ RADAR CHART ‚îÄ‚îÄ‚îÄ */
  .radar-wrap {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  .radar-chart-wrap {
    position: relative;
    height: 300px;
  }

  /* ‚îÄ‚îÄ‚îÄ SIGNAL CARDS (CYBER-LOG) ‚îÄ‚îÄ‚îÄ */
  .signal-log-feed {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .signal-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-left: 3px solid;
    padding: 14px 16px;
    position: relative;
    overflow: hidden;
    transition: background 0.15s;
  }

  .signal-card:hover {
    background: var(--surface3);
  }

  .signal-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    opacity: 0.3;
  }

  .signal-card.sc-buy    { border-left-color: var(--accent2); }
  .signal-card.sc-buy::after    { background: var(--accent2); }
  .signal-card.sc-watch  { border-left-color: var(--warn); }
  .signal-card.sc-watch::after  { background: var(--warn); }
  .signal-card.sc-sell   { border-left-color: #e879f9; }
  .signal-card.sc-sell::after   { background: #e879f9; }
  .signal-card.sc-neutral { border-left-color: var(--text3); }

  .sc-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
  }

  .sc-timestamp {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    letter-spacing: 1px;
  }

  .sc-level {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
    padding: 2px 6px;
    border: 1px solid;
    text-transform: uppercase;
    font-weight: 700;
  }

  .sc-level.lvl-buy   { color: var(--accent2); border-color: rgba(0,255,157,0.4); background: rgba(0,255,157,0.06); }
  .sc-level.lvl-watch { color: var(--warn); border-color: rgba(255,209,102,0.4); background: rgba(255,209,102,0.06); }
  .sc-level.lvl-sell  { color: #e879f9; border-color: rgba(232,121,249,0.4); background: rgba(232,121,249,0.06); }
  .sc-level.lvl-neutral { color: var(--text3); border-color: var(--border); }

  .sc-log-line {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    line-height: 1.5;
    color: var(--text2);
  }

  .sc-log-line .sc-ticker-ref {
    color: var(--accent);
    font-weight: 700;
  }

  .sc-log-line .sc-value-buy   { color: var(--accent2); font-weight: 700; }
  .sc-log-line .sc-value-watch { color: var(--warn); font-weight: 700; }
  .sc-log-line .sc-value-sell  { color: #e879f9; font-weight: 700; }

  .sc-rec {
    margin-top: 6px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .sc-rec.buy-rec   { color: var(--accent2); }
  .sc-rec.watch-rec { color: var(--warn); }
  .sc-rec.sell-rec  { color: #e879f9; }

  /* ‚îÄ‚îÄ‚îÄ MONETARY PERF FLUX TABLE ‚îÄ‚îÄ‚îÄ */
  .flux-table-wrap .flux-tr {
    display: grid;
    grid-template-columns: 100px 1fr 120px 240px;
    gap: 0;
    align-items: center;
    border-bottom: 1px solid rgba(30,45,61,0.5);
    padding: 12px 20px;
    transition: background 0.15s;
  }

  .flux-table-wrap .flux-tr:hover { background: var(--surface2); }

  .flux-table-wrap .flux-header {
    font-size: 9px;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
  }

  .flux-nom {
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    color: var(--text);
    font-weight: 700;
  }

  .flux-name-full {
    font-size: 11px;
    color: var(--text3);
    padding-left: 16px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .flux-pv {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    text-align: right;
  }

  .flux-bar-cell {
    padding-left: 16px;
  }

  .flux-bar-track {
    height: 6px;
    background: var(--surface3);
    overflow: hidden;
    margin-bottom: 4px;
  }

  .flux-bar-fill {
    height: 100%;
    transition: width 1s ease;
  }

  .flux-bar-pct {
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
  }

  /* ‚îÄ‚îÄ‚îÄ STRESS LEVEL BADGE ‚îÄ‚îÄ‚îÄ */
  .stress-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
  }

  .stress-low {
    background: rgba(0,255,157,0.08);
    border: 1px solid rgba(0,255,157,0.3);
    color: var(--accent2);
  }

  .stress-medium {
    background: rgba(255,209,102,0.08);
    border: 1px solid rgba(255,209,102,0.3);
    color: var(--warn);
  }

  .stress-high {
    background: rgba(239,35,60,0.1);
    border: 1px solid rgba(239,35,60,0.4);
    color: var(--danger);
    animation: stressPulse 2s ease infinite;
  }

  @keyframes stressPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239,35,60,0); }
    50% { box-shadow: 0 0 8px 2px rgba(239,35,60,0.25); }
  }

  /* ‚îÄ‚îÄ‚îÄ COLLAPSIBLE SIDE DRAWER PANELS ‚îÄ‚îÄ‚îÄ */
  .tab-layout {
    display: flex;
    gap: 0;
    min-height: 600px;
    position: relative;
  }

  .tab-content-main {
    flex: 1;
    min-width: 0;
    transition: margin-right 0.3s ease;
  }

  .side-drawer {
    width: 0;
    overflow: hidden;
    transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
    background: var(--surface);
    border-left: 1px solid var(--border);
    position: relative;
  }

  .side-drawer.open {
    width: 340px;
  }

  .side-drawer-inner {
    width: 340px;
    height: 100%;
    overflow-y: auto;
    padding: 20px;
  }

  .drawer-toggle-btn {
    position: fixed;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    z-index: 80;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-right: none;
    color: var(--text3);
    cursor: pointer;
    padding: 12px 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
    writing-mode: vertical-rl;
    text-orientation: mixed;
  }

  .drawer-toggle-btn:hover {
    background: var(--surface3);
    color: var(--accent);
    border-color: var(--accent);
  }

  .drawer-toggle-btn.open {
    right: 340px;
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(0,212,255,0.06);
  }

  .drawer-section-title {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .drawer-section-title::before {
    content: '';
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .drawer-kpi-block {
    margin-bottom: 20px;
  }

  .drawer-kpi-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(30,45,61,0.4);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
  }

  .drawer-kpi-label { color: var(--text3); }
  .drawer-kpi-val   { color: var(--text); font-weight: 700; }

  /* ‚îÄ‚îÄ‚îÄ BENTO GRID SECTEURS ‚îÄ‚îÄ‚îÄ */
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    grid-auto-rows: 150px;
    gap: 14px;
    padding: 4px 0;
  }

  .bento-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    cursor: default;
  }

  .bento-card:hover {
    transform: translateY(-4px);
    border-color: var(--accent);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }

  .bento-card.is-etf {
    border: 1.5px solid rgba(0, 212, 255, 0.4);
    background: linear-gradient(145deg, var(--surface2), #0a141d);
    box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.05);
  }

  .bento-card.is-warn {
    border-color: rgba(255, 107, 53, 0.5);
    box-shadow: inset 0 0 15px rgba(255, 107, 53, 0.04);
  }

  .bento-card.span2 { grid-column: span 2; }

  .etf-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    background: rgba(0, 212, 255, 0.15);
    color: var(--accent);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--accent);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .warn-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 9px;
    font-family: 'Space Mono', monospace;
    background: rgba(255, 107, 53, 0.15);
    color: var(--accent3);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--accent3);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .bento-sector-label {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    color: var(--text);
    letter-spacing: -0.5px;
    padding-right: 60px;
  }

  .bento-weight-val {
    font-family: 'Space Mono', monospace;
    font-size: 1.9rem;
    font-weight: 700;
    color: var(--accent2);
    line-height: 1;
  }

  .bento-card.is-etf .bento-weight-val { color: var(--accent); }
  .bento-card.is-warn .bento-weight-val { color: var(--accent3); }

  .bento-valeur {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text3);
  }

  .bento-progress-bg {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: var(--accent2);
    opacity: 0.6;
    transition: width 1s ease-in-out;
  }

  .bento-card.is-etf .bento-progress-bg { background: var(--accent); }
  .bento-card.is-warn .bento-progress-bg { background: var(--accent3); }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOCK SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="lock-screen">
  <div class="lock-container">
    <div class="lock-logo">‚ñ∂ PEA LIVE SYSTEM</div>
    <h1 class="lock-title">Dashboard<br><span>Priv√©</span> 2.0</h1>
    <p class="lock-sub">// Acc√®s s√©curis√© requis</p>

    <label class="lock-label" for="api-url">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>
      URL Google Apps Script
    </label>
    <div class="lock-input-wrap" style="margin-bottom:16px">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>
      <input type="url" id="api-url" placeholder="https://script.google.com/macros/s/..." autocomplete="off">
    </div>

    <label class="lock-label" for="api-key">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 0 1 21.75 8.25Z" /></svg>
      Cl√© API / Token
    </label>
    <div class="lock-input-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 0 1 3 3m3 0a6 6 0 0 1-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 0 1 21.75 8.25Z" /></svg>
      <input type="password" id="api-key" placeholder="Votre cl√© secr√®te" autocomplete="off">
    </div>

    <button class="lock-btn" id="unlock-btn" onclick="handleUnlock()" type="button">
      <span class="btn-text">ACC√âDER AU DASHBOARD ‚Üí</span>
      <span class="btn-spinner"></span>
    </button>

    <div class="remember-row">
      <input type="checkbox" id="remember-me" checked>
      <label for="remember-me">M√©moriser mes identifiants sur cet appareil</label>
    </div>

    <div id="lock-error">‚ö† Connexion √©chou√©e ‚Äî V√©rifiez votre URL et votre cl√© API.</div>

    <div class="lock-hint">
      üí° L'URL doit √™tre celle de votre d√©ploiement Google Apps Script<br>
      La cl√© est pass√©e en param√®tre <code>?key=VOTRE_CLE</code>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-brand">
      <div class="brand-icon">üìä</div>
      <div>
        <div class="brand-name">PEA Live <span>2.0</span></div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="live-badge">
        <div class="live-dot"></div>
        LIVE
      </div>
      <div class="last-update" id="last-update-display">--</div>
      <button class="refresh-btn" onclick="refreshData()">
        ‚Ü∫ REFRESH
      </button>
      <button class="logout-btn" onclick="logout()">‚èª</button>
    </div>
  </header>

  <main class="main">

    <!-- ALERT BANNER -->
    <div class="alert-banner" id="alert-banner"></div>

    <!-- LOADING STATE -->
    <div class="loading" id="loading-state">
      <div class="spinner"></div>
      <div class="loading-text">CHARGEMENT DES DONN√âES...</div>
    </div>

    <!-- DASHBOARD CONTENT -->
    <div id="dashboard-content" style="display:none">

      <!-- TAB NAVIGATION -->
      <div class="tab-nav">
        <button class="tab-btn active" id="tab-btn-global" onclick="switchTab('global')">‚óà Vue Globale</button>
        <button class="tab-btn" id="tab-btn-health" onclick="switchTab('health')">‚óà Sant√© Portefeuille</button>
        <button class="tab-btn" id="tab-btn-perf" onclick="switchTab('perf')">‚óà Performance</button>
      </div>

      <!-- ‚ïê‚ïê‚ïê VUE GLOBALE ‚ïê‚ïê‚ïê -->
      <div id="tab-global" class="tab-view active">

      <!-- HERO HEADER -->
      <div class="hero">
        <div class="hero-left">
          <h1>VALEUR TOTALE DU PORTEFEUILLE</h1>
          <div class="portfolio-value">
            <span class="currency">‚Ç¨</span><span id="total-value">--</span>
          </div>
          <div class="pv-row">
            <div class="pv-chip" id="pv-chip-eur">
              <span>‚ñ≤</span> <span id="pv-eur">--</span>
            </div>
            <div class="pv-chip" id="pv-chip-pct">
              <span>%</span> <span id="pv-pct">--</span>
            </div>
            <div style="font-size:12px; color: var(--text3); font-family:'Space Mono',monospace;" id="nb-lignes-display"></div>
          </div>
        </div>
        <!-- HUD BIOMETRIC SCAN -->
        <div class="kpi-visual-bridge">
          <svg class="hud-svg" viewBox="-60 -60 120 120" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="hud-glow">
                <feGaussianBlur stdDeviation="1.5" result="blur"/>
                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
              </filter>
              <filter id="hud-glow-soft">
                <feGaussianBlur stdDeviation="0.8" result="blur"/>
                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
              </filter>
            </defs>
            <!-- Cercle ext√©rieur pointill√© ‚Äî rotation horaire -->
            <g class="hud-outer-ring">
              <circle cx="0" cy="0" r="54" fill="none" stroke="#00d4ff" stroke-width="0.6"
                stroke-dasharray="3 5" opacity="0.7" filter="url(#hud-glow-soft)"/>
              <line x1="0" y1="-54" x2="0" y2="-50" stroke="#00d4ff" stroke-width="0.8" opacity="0.9"/>
              <line x1="54" y1="0" x2="50" y2="0" stroke="#00d4ff" stroke-width="0.8" opacity="0.9"/>
              <line x1="0" y1="54" x2="0" y2="50" stroke="#00d4ff" stroke-width="0.8" opacity="0.9"/>
              <line x1="-54" y1="0" x2="-50" y2="0" stroke="#00d4ff" stroke-width="0.8" opacity="0.9"/>
            </g>
            <!-- Cercle interm√©diaire segment√© ‚Äî rotation anti-horaire -->
            <g class="hud-inner-ring">
              <circle cx="0" cy="0" r="42" fill="none" stroke="#00ff9d" stroke-width="0.5"
                stroke-dasharray="8 4 2 4" opacity="0.5"/>
              <circle cx="0" cy="0" r="38" fill="none" stroke="#00d4ff" stroke-width="0.4"
                stroke-dasharray="1.5 10.5" opacity="0.6" filter="url(#hud-glow-soft)"/>
            </g>
            <!-- Arc de scan anim√© -->
            <g class="hud-scan-arc">
              <path d="M 0,-48 A 48,48 0 0,1 33.9,-33.9" fill="none"
                stroke="#00d4ff" stroke-width="1.2" stroke-linecap="round"
                opacity="0.9" filter="url(#hud-glow)"/>
            </g>
            <!-- Cercle de r√©f√©rence int√©rieur -->
            <circle cx="0" cy="0" r="26" fill="none" stroke="#00d4ff"
              stroke-width="0.4" stroke-dasharray="2 3" opacity="0.3"/>
            <!-- Croix centrale -->
            <line x1="-14" y1="0" x2="14" y2="0" stroke="#00d4ff" stroke-width="0.5" opacity="0.4"/>
            <line x1="0" y1="-14" x2="0" y2="14" stroke="#00d4ff" stroke-width="0.5" opacity="0.4"/>
            <!-- Point central pulse -->
            <circle cx="0" cy="0" r="3" fill="#00d4ff" class="hud-pulse" filter="url(#hud-glow)"/>
            <!-- Texte PEA -->
            <text x="0" y="4" text-anchor="middle"
              font-family="Syne, sans-serif" font-weight="700"
              font-size="8" fill="#00ff9d" letter-spacing="2"
              class="hud-pulse-text" filter="url(#hud-glow-soft)">PEA</text>
            <!-- Labels coins -->
            <text x="-54" y="-46" font-family="Space Mono, monospace" font-size="4.5" fill="#00d4ff" opacity="0.5">SYS</text>
            <text x="54" y="-46" font-family="Space Mono, monospace" font-size="4.5" fill="#00d4ff" opacity="0.5" text-anchor="end">LIVE</text>
            <text x="-54" y="52" font-family="Space Mono, monospace" font-size="4.5" fill="#00ff9d" opacity="0.5">2.0</text>
            <text x="54" y="52" font-family="Space Mono, monospace" font-size="4.5" fill="#00ff9d" opacity="0.5" text-anchor="end">‚ñ∏OK</text>
          </svg>
        </div>

        <div class="hero-right">
          <!-- HEALTH CARD -->
          <div class="health-card">
            <div class="health-header">
              <div class="health-title">üè• SANT√â PEA</div>
              <div class="health-score" id="health-score-display">--</div>
            </div>
            <div class="health-label" id="health-label">--</div>
            <div class="health-bar-track">
              <div class="health-bar-fill" id="health-bar" style="width:0%"></div>
            </div>
            <div class="health-details" id="health-details"></div>
          </div>
        </div>
      </div>

      <!-- STAT CARDS -->
      <div class="stats-row" id="stats-row">
        <div class="stat-card">
          <div class="stat-card-label">Positions actives</div>
          <div class="stat-card-value" id="stat-positions">--</div>
          <div class="stat-card-sub">titres en portefeuille</div>
          <div class="accent-line"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Meilleure position</div>
          <div class="stat-card-value" id="stat-best" style="font-size:16px;color:var(--accent2)">--</div>
          <div class="stat-card-sub" id="stat-best-pct">--</div>
          <div class="accent-line" style="background:var(--accent2)"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Moins-value max</div>
          <div class="stat-card-value" id="stat-worst" style="font-size:16px;color:var(--danger)">--</div>
          <div class="stat-card-sub" id="stat-worst-pct">--</div>
          <div class="accent-line" style="background:var(--danger)"></div>
        </div>
        <div class="stat-card">
          <div class="stat-card-label">Secteurs</div>
          <div class="stat-card-value" id="stat-sectors">--</div>
          <div class="stat-card-sub">actifs dans le PEA</div>
          <div class="accent-line" style="background:var(--accent3)"></div>
        </div>
      </div>

      <!-- PORTFOLIO + SECTORS -->
      <div class="grid-2-1">
        <!-- PORTFOLIO TABLE -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <div class="dot"></div>
              PORTEFEUILLE
            </div>
            <span class="panel-badge" id="portfolio-count-badge">0 titres</span>
          </div>
          <div class="panel-body" style="padding:0">
            <div class="table-wrap">
              <table id="portfolio-table">
                <thead>
                  <tr>
                    <th>Ticker</th>
                    <th>Nom</th>
                    <th>Qt√©</th>
                    <th>PRU</th>
                    <th>Cours</th>
                    <th>Var. J</th>
                    <th>Valeur</th>
                    <th>PV‚Ç¨</th>
                    <th>PV%</th>
                    <th>Poids</th>
                    <th>Signal</th>
                  </tr>
                </thead>
                <tbody id="portfolio-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- SECTORS PANEL -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <div class="dot" style="background:var(--accent3)"></div>
              SECTEURS
            </div>
          </div>
          <div class="panel-body">
            <div class="chart-wrap-sm">
              <canvas id="donut-chart"></canvas>
            </div>
            <div id="sector-list" style="margin-top:16px"></div>
          </div>
        </div>
      </div>

      <!-- HISTORIQUE -->
      <div class="panel historique-panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot" style="background:var(--accent2)"></div>
            HISTORIQUE DU PATRIMOINE
          </div>
          <span class="panel-badge" id="hist-count-badge">-- points</span>
        </div>
        <div class="panel-body">
          <div class="chart-wrap">
            <canvas id="history-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- WATCHLIST -->
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <div class="dot" style="background:var(--warn)"></div>
            WATCHLIST ‚Äî En Surveillance
          </div>
        </div>
        <div class="panel-body" style="padding:0">
          <div id="watchlist-body"></div>
        </div>
      </div>


      </div><!-- /tab-global -->

      <!-- ‚ïê‚ïê‚ïê SANT√â PORTEFEUILLE ‚ïê‚ïê‚ïê -->
      <div id="tab-health" class="tab-view">

        <!-- Tooltip global for Nucleus -->
        <div id="nucleus-tooltip">
          <div class="tt-header">[DATA_SCAN]</div>
          <div id="tt-content"></div>
        </div>

        <!-- TAB LAYOUT WITH SIDE DRAWER -->
        <div class="tab-layout">
          <div class="tab-content-main" id="health-main-content">

            <!-- FILTER ROW -->
            <div class="cat-filter-row">
              <span class="cat-filter-label">Filtre :</span>
              <button class="cat-btn active" id="hf-btn-all" onclick="filterHealth('all')">Tout</button>
              <button class="cat-btn" id="hf-btn-action" onclick="filterHealth('action')">Actions</button>
              <button class="cat-btn etf" id="hf-btn-etf" onclick="filterHealth('etf')">ETF</button>
            </div>

            <!-- SCORE CARDS GRID -->
            <div class="health-grid" id="health-score-grid"></div>

            <!-- BENTO GRID SECTEURS -->
            <div class="panel" style="margin-bottom:24px">
              <div class="panel-header">
                <div class="panel-title">
                  <div class="dot" style="background:var(--accent)"></div>
                  SMART DIVERSIFICATION ‚Äî R√©partition Sectorielle
                </div>
              </div>
              <div class="panel-body">
                <div class="bento-grid" id="bento-container"></div>
              </div>
            </div>

            <!-- RADAR + SIGNALS LAYOUT -->            <!-- RADAR + SIGNALS LAYOUT -->
            <div class="radar-wrap">
              <!-- RADAR CHART PANEL -->
              <div class="panel">
                <div class="panel-header">
                  <div class="panel-title">
                    <div class="dot" style="background:var(--accent)"></div>
                    RADAR ‚Äî Analyse Multi-Crit√®res
                  </div>
                  <div style="display:flex;gap:6px">
                    <button class="cat-btn active" id="rr-btn-all" onclick="filterRadar('all')" style="font-size:9px;padding:3px 10px">Tout</button>
                    <button class="cat-btn" id="rr-btn-action" onclick="filterRadar('action')" style="font-size:9px;padding:3px 10px">Actions</button>
                    <button class="cat-btn etf" id="rr-btn-etf" onclick="filterRadar('etf')" style="font-size:9px;padding:3px 10px">ETF</button>
                  </div>
                </div>
                <div class="panel-body">
                  <div class="radar-chart-wrap">
                    <canvas id="radar-chart"></canvas>
                  </div>
                </div>
              </div>

              <!-- SIGNAL CARDS PANEL -->
              <div class="panel">
                <div class="panel-header">
                  <div class="panel-title">
                    <div class="dot" style="background:#e879f9"></div>
                    SIGNAL INTELLIGENCE ‚Äî Cyber Log
                  </div>
                  <span class="panel-badge" id="signal-log-count">-- signaux</span>
                </div>
                <div class="panel-body" style="max-height:340px;overflow-y:auto">
                  <div class="signal-log-feed" id="signal-log-feed"></div>
                </div>
              </div>
            </div>

          </div><!-- /tab-content-main -->

          <!-- SIDE DRAWER -->
          <div class="side-drawer" id="health-drawer">
            <div class="side-drawer-inner">
              <div class="drawer-section-title">Synth√®se Sant√©</div>
              <div class="drawer-kpi-block" id="drawer-health-kpis">
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Score Global</span><span class="drawer-kpi-val" id="drawer-score">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">ETF / Actions</span><span class="drawer-kpi-val" id="drawer-etf-split">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Concentration max</span><span class="drawer-kpi-val" id="drawer-max-conc">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Marge moy.</span><span class="drawer-kpi-val" id="drawer-marge">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Positions +PV</span><span class="drawer-kpi-val" id="drawer-pos-pv" style="color:var(--accent2)">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Positions -PV</span><span class="drawer-kpi-val" id="drawer-neg-pv" style="color:var(--danger)">--</span></div>
              </div>

              <div class="drawer-section-title">Nucleus ‚Äî D√©tail Secteur</div>
              <div id="drawer-nucleus-detail" style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);line-height:1.8">
                Cliquez un secteur<br>sur le Nucleus<br>pour voir le d√©tail.
              </div>
            </div>
          </div><!-- /side-drawer -->
        </div><!-- /tab-layout -->

        <!-- DRAWER TOGGLE BTN (health tab) -->
        <button class="drawer-toggle-btn" id="health-drawer-btn" onclick="toggleDrawer('health')">‚óà D√âTAILS</button>

      </div><!-- /tab-health -->



      <!-- ‚ïê‚ïê‚ïê VUE PERFORMANCE ‚ïê‚ïê‚ïê -->
      <div id="tab-perf" class="tab-view">
        <div class="tab-layout">
          <div class="tab-content-main">

        <!-- STICKY SUMMARY HEADER -->
        <div class="perf-sticky-header" id="perf-sticky">
          <div class="perf-sticky-kpi">
            <div class="perf-sticky-label">Valeur Totale</div>
            <div class="perf-sticky-val" id="ps-valeur" style="color:var(--text)">--</div>
          </div>
          <div class="perf-sticky-divider"></div>
          <div class="perf-sticky-kpi">
            <div class="perf-sticky-label">PV Globale ‚Ç¨</div>
            <div class="perf-sticky-val" id="ps-pv-eur">--</div>
          </div>
          <div class="perf-sticky-divider"></div>
          <div class="perf-sticky-kpi">
            <div class="perf-sticky-label">PV Globale %</div>
            <div class="perf-sticky-val" id="ps-pv-pct">--</div>
          </div>
          <div class="perf-sticky-divider"></div>
          <div class="perf-sticky-kpi">
            <div class="perf-sticky-label">Meilleur</div>
            <div class="perf-sticky-val" id="ps-best" style="color:var(--accent2)">--</div>
          </div>
          <div class="perf-sticky-divider"></div>
          <div class="perf-sticky-kpi">
            <div class="perf-sticky-label">Pire</div>
            <div class="perf-sticky-val" id="ps-worst" style="color:var(--danger)">--</div>
          </div>
        </div>

        <!-- MASTER PERFORMANCE LEDGER -->
        <div class="panel" style="margin-bottom:24px">
          <div class="panel-header">
            <div class="panel-title">
              <div class="dot"></div>
              MASTER PERFORMANCE LEDGER
            </div>
            <span class="panel-badge">Positions actives uniquement</span>
          </div>
          <div class="panel-body" style="padding:0">
            <div class="table-wrap">
              <table class="perf-table" id="perf-table">
                <thead>
                  <tr>
                    <th>Ticker</th>
                    <th>Nom</th>
                    <th>Cours</th>
                    <th>PRU</th>
                    <th style="text-align:right">Var. J</th>
                    <th style="text-align:right">PV‚Ç¨</th>
                    <th style="text-align:right">PV%</th>
                    <th style="text-align:right">Contribution</th>
                    <th style="text-align:center">Tendance 7j</th>
                    <th>Signal</th>
                  </tr>
                </thead>
                <tbody id="perf-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- EQUITY CURVE FOCUS -->
        <div class="panel" style="margin-bottom:24px">
          <div class="panel-header">
            <div class="panel-title">
              <div class="dot" style="background:var(--accent2)"></div>
              EQUITY CURVE ‚Äî Analyse Patrimoine
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <div id="ath-badge" class="ath-badge" style="display:none">ATH: --</div>
              <div id="dd-badge" class="drawdown-badge" style="display:none">DD: --</div>
              <div class="timeframe-row">
                <button class="tf-btn" onclick="setTimeframe('1M')">1M</button>
                <button class="tf-btn" onclick="setTimeframe('3M')">3M</button>
                <button class="tf-btn" onclick="setTimeframe('6M')">6M</button>
                <button class="tf-btn" onclick="setTimeframe('YTD')">YTD</button>
                <button class="tf-btn active" onclick="setTimeframe('ALL')">ALL</button>
              </div>
            </div>
          </div>
          <div class="panel-body">
            <div class="equity-chart-wrap">
              <canvas id="equity-chart"></canvas>
            </div>
          </div>
        </div>

          </div><!-- /tab-content-main -->

          <!-- SIDE DRAWER PERF -->
          <div class="side-drawer" id="perf-drawer">
            <div class="side-drawer-inner">
              <div class="drawer-section-title">R√©sum√© Performance</div>
              <div class="drawer-kpi-block">
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Valeur Totale</span><span class="drawer-kpi-val" id="pd-valeur">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">PV Globale ‚Ç¨</span><span class="drawer-kpi-val" id="pd-pv-eur">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">PV Globale %</span><span class="drawer-kpi-val" id="pd-pv-pct">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Meilleur ticker</span><span class="drawer-kpi-val" style="color:var(--accent2)" id="pd-best">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Pire ticker</span><span class="drawer-kpi-val" style="color:var(--danger)" id="pd-worst">--</span></div>
              </div>
              <div class="drawer-section-title">Equity Curve</div>
              <div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);line-height:1.8">
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">ATH</span><span class="drawer-kpi-val" id="pd-ath">--</span></div>
                <div class="drawer-kpi-row"><span class="drawer-kpi-label">Drawdown</span><span class="drawer-kpi-val" id="pd-dd" style="color:var(--danger)">--</span></div>
              </div>
            </div>
          </div><!-- /side-drawer perf -->
        </div><!-- /tab-layout perf -->
        <button class="drawer-toggle-btn" id="perf-drawer-btn" onclick="toggleDrawer('perf')">‚óà R√âSUM√â</button>

      </div><!-- /tab-perf -->

    </div><!-- /dashboard-content -->
  </main>
</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let API_URL = '';
let API_KEY = '';
let donutChart = null;
let historyChart = null;

const SECTOR_COLORS = [
  '#00d4ff', '#00ff9d', '#ff6b35', '#ffd166',
  '#a78bfa', '#fb7185', '#34d399', '#f97316',
  '#60a5fa', '#e879f9'
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function val(obj, ...keys) {
  for (const k of keys) {
    if (obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];
    const kNoSpace = k.replace(/\s/g, '');
    for (const ok of Object.keys(obj)) {
      if (ok.replace(/\s/g, '') === kNoSpace) {
        if (obj[ok] !== undefined && obj[ok] !== null && obj[ok] !== '') return obj[ok];
      }
    }
  }
  return undefined;
}

function numVal(obj, ...keys) {
  const v = val(obj, ...keys);
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function fmt(v, decimals = 2) {
  return Number(v).toLocaleString('fr-FR', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
}

function escH(str) {
  return String(str || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showAlert(type, msg) {
  const banner = document.getElementById('alert-banner');
  if (!banner) return;
  banner.className = 'alert-banner show ' + type;
  banner.textContent = msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH / LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  const savedUrl = localStorage.getItem('pea_api_url');
  const savedKey = localStorage.getItem('pea_api_key');

  const urlField = document.getElementById('api-url');
  const keyField = document.getElementById('api-key');

  if (savedUrl) urlField.value = savedUrl;
  else urlField.value = "https://script.google.com/macros/s/AKfycbwwh6nOe9RhFL_14q6rSd51XG9QlXgizxInrfvPxE4enYVp0nLxtSCn_S7_jiS2QkGD/exec";
  if (savedKey) keyField.value = savedKey;

  if (savedUrl && savedKey) {
    API_URL = savedUrl;
    API_KEY = savedKey;
    document.getElementById('lock-screen').style.display = 'none';
    document.getElementById('app').classList.add('visible');
    fetchData();
  }

  urlField.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); keyField.focus(); }
  });
  keyField.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleUnlock();
  });
});

function handleUnlock() {
  let url = document.getElementById('api-url').value.trim();
  let key = document.getElementById('api-key').value.trim();

  if (!url) url = "https://script.google.com/macros/s/AKfycbwwh6nOe9RhFL_14q6rSd51XG9QlXgizxInrfvPxE4enYVp0nLxtSCn_S7_jiS2QkGD/exec";
  if (!key) { showAlert('danger', '‚ö† Veuillez saisir votre cl√© API.'); return; }

  API_URL = url;
  API_KEY = key;

  if (document.getElementById('remember-me') && document.getElementById('remember-me').checked) {
    localStorage.setItem('pea_api_url', url);
    localStorage.setItem('pea_api_key', key);
  }

  document.getElementById('lock-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  fetchData();
}

function logout() {
  localStorage.removeItem('pea_api_url');
  localStorage.removeItem('pea_api_key');
  API_URL = ''; API_KEY = '';
  document.getElementById('lock-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('dashboard-content').style.display = 'none';
  document.getElementById('loading-state').style.display = 'flex';
  if (donutChart) { donutChart.destroy(); donutChart = null; }
  if (historyChart) { historyChart.destroy(); historyChart = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FETCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchData() {
  document.getElementById('loading-state').style.display = 'flex';
  document.getElementById('dashboard-content').style.display = 'none';
  try {
    const resp = await fetch(`${API_URL}?key=${encodeURIComponent(API_KEY)}`, { redirect: 'follow' });
    const json = await resp.json();
    if (json.error) { showAlert('danger', '‚ö† Cl√© API invalide ‚Äî ' + json.error); return; }
    renderDashboard(json);
    document.getElementById('last-update-display').textContent =
      new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  } catch (err) {
    console.error('Fetch error:', err);
    showAlert('warn', '‚ö† Connexion impossible ‚Äî v√©rifiez votre r√©seau et l\'URL Apps Script.');
    document.getElementById('loading-state').style.display = 'none';
  }
}

function refreshData() { if (API_URL && API_KEY) fetchData(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(json) {
  const EXCLUS = ['TOTAL PORTEFEUILLE', 'TOTAL', 'Diagnostic Rapide', 'Score Sant√©'];
  const portfolio = (json['PORTFOLIO'] || []).filter(r => {
    const t = String(val(r, 'Ticker', 'ticker') || '').trim();
    if (!t) return false;
    if (EXCLUS.some(ex => t.includes(ex))) return false;
   // Exclure les lignes dont le ticker est purement num√©rique (ex: 45, 100...)
    if (/^\d+$/.test(t)) return false;
  // Exclure les lignes sans pr√©fixe boursier valide ET sans nom
    const nom = String(val(r, 'Nom', 'nom') || '').trim();
    if (!nom && !/^(EPA|ETR|NASDAQ|NYSE|AMS|BIT|SWX):/i.test(t)) return false;
    return numVal(r, 'Cours (‚Ç¨)', 'cours') > 0;
  });

  updateSummary(json, portfolio);
  renderTable(portfolio);
  renderCharts(json['Secteurs'] || [], json['Historique_Patrimoine'] || []);

  // Alerte surexposition ‚Äî ignor√©e pour les ETF
  const surexp = (json['Secteurs'] || []).filter(s => {
    const alerte  = String(val(s, '‚ö†Ô∏è Alerte') || '');
    const secteur = String(val(s, 'Secteur') || '');
    const isETF   = /etf|index|tracker|indice|monde|world/i.test(secteur);
    return alerte.includes('Surexpos√©') && !isETF;
  });
  if (surexp.length) {
    showAlert('danger', 'üî¥ SUREXPOSITION : ' + surexp.map(s =>
      val(s, 'Secteur') + ' (' + (numVal(s, 'Poids (%)') * 100).toFixed(1) + '%)'
    ).join(', '));
  }

  document.getElementById('loading-state').style.display = 'none';
  document.getElementById('dashboard-content').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPDATE SUMMARY (hero + stats + health)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSummary(json, portfolio) {
  // Totaux
  let totalValeur = 0, totalPV = 0;
  const ligneTotal = (json['PORTFOLIO'] || []).find(r =>
    String(r['Ticker'] || '').includes('TOTAL PORTEFEUILLE')
  );
  if (ligneTotal) {
    totalValeur = numVal(ligneTotal, 'Valeur (‚Ç¨)');
    totalPV     = numVal(ligneTotal, 'PV (‚Ç¨)');
  } else {
    portfolio.forEach(r => {
      totalValeur += numVal(r, 'Valeur (‚Ç¨)', 'valeur');
      totalPV     += numVal(r, 'PV (‚Ç¨)', 'pv');
    });
  }
  const isPos = totalPV >= 0;
  const pvPct = totalValeur > 0 ? (totalPV / (totalValeur - totalPV)) * 100 : 0;

  document.getElementById('total-value').textContent = fmt(totalValeur);
  document.getElementById('pv-eur').textContent = (isPos ? '+' : '') + fmt(totalPV) + ' ‚Ç¨';
  document.getElementById('pv-pct').textContent = (isPos ? '+' : '') + pvPct.toFixed(2) + '%';
  document.getElementById('pv-chip-eur').className = 'pv-chip ' + (isPos ? 'positive' : 'negative');
  document.getElementById('pv-chip-pct').className = 'pv-chip ' + (isPos ? 'positive' : 'negative');
  const pvChipEur = document.getElementById('pv-chip-eur');
  if (pvChipEur) pvChipEur.querySelector('span').textContent = isPos ? '‚ñ≤' : '‚ñº';
  const nbEl = document.getElementById('nb-lignes-display');
  if (nbEl) nbEl.textContent = portfolio.length + ' position' + (portfolio.length > 1 ? 's' : '') + ' active' + (portfolio.length > 1 ? 's' : '');

  // Stat cards
  document.getElementById('stat-positions').textContent = portfolio.length;
  let best = null, worst = null;
  portfolio.forEach(r => {
    const pct  = numVal(r, 'PV (%)', 'pv_pct');
    const name = String(val(r, 'Ticker', 'ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    if (pct !== 0) {
      if (!best || pct > best.pct) best = { name, pct };
      if (!worst || pct < worst.pct) worst = { name, pct };
    }
  });
  if (best) {
    document.getElementById('stat-best').textContent = best.name;
    document.getElementById('stat-best-pct').textContent = '+' + (best.pct * 100).toFixed(1) + '%';
  }
  if (worst) {
    document.getElementById('stat-worst').textContent = worst.name;
    document.getElementById('stat-worst-pct').textContent = (worst.pct * 100).toFixed(1) + '%';
  }
  const activeSectors = (json['Secteurs'] || []).filter(s => numVal(s, 'Valeur (‚Ç¨)') > 0);
  const statSectors = document.getElementById('stat-sectors');
  if (statSectors) statSectors.textContent = activeSectors.length;

  // Sant√©
  renderHealth(json['Sant√© PEA'] || [], portfolio);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HEALTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHealth(sante, portfolio) {
  const score = computeHealthScore(portfolio);
  const scoreColor = score >= 75 ? 'var(--accent2)' : score >= 50 ? 'var(--warn)' : 'var(--danger)';
  const scoreEl = document.getElementById('health-score-display');
  if (scoreEl) { scoreEl.textContent = score + '/100'; scoreEl.style.color = scoreColor; }
  const labelEl = document.getElementById('health-label');
  if (labelEl) { labelEl.textContent = getHealthLabel(score); labelEl.style.color = scoreColor; }
  setTimeout(() => {
    const bar = document.getElementById('health-bar');
    if (bar) bar.style.width = score + '%';
  }, 300);

  // maxPoids : ETF exclus sauf si > 70%
  const maxPoidsActions = portfolio.filter(p => !isETF(p)).reduce((m, p) => Math.max(m, numVal(p, 'Poids(%)', 'Poids (%)')), 0);
  const maxPoidsETF     = portfolio.filter(p => isETF(p)).reduce((m, p) => Math.max(m, numVal(p, 'Poids(%)', 'Poids (%)')), 0);
  const maxPoids        = maxPoidsActions; // Pour la couleur, seules les actions comptent
  const maxPoidsDisplay = portfolio.reduce((m, p) => Math.max(m, numVal(p, 'Poids(%)', 'Poids (%)')), 0); // Vraie valeur affich√©e
  const concColor = maxPoidsActions > 0.35 ? 'var(--danger)' : maxPoidsActions > 0.20 ? 'var(--warn)' : 'var(--accent)';
  const withMarge = portfolio.filter(p => {
    const m = val(p, 'Marge de S√©curit√© (%)');
    return m != null && m !== '' && m !== '--';
  });
  const avgMarge = withMarge.length
    ? withMarge.reduce((a, p) => a + numVal(p, 'Marge de S√©curit√© (%)'), 0) / withMarge.length
    : 0;
  const nbActif = portfolio.filter(p => numVal(p, 'Valeur (‚Ç¨)', 'valeur') > 0).length;

  const div = document.getElementById('health-details');
  if (div) div.innerHTML = `
    <div class="health-item"><div class="health-item-label">LIGNES ACTIVES</div><div class="health-item-val">${nbActif}</div></div>
    <div class="health-item"><div class="health-item-label">MAX CONCENTRATION</div><div class="health-item-val" style="color:${concColor}">${(maxPoidsDisplay * 100).toFixed(1)}%</div></div>
    <div class="health-item"><div class="health-item-label">MARGE S√âCU MOY.</div><div class="health-item-val">${(avgMarge * 100).toFixed(1)}%</div></div>
    <div class="health-item"><div class="health-item-label">SCORE</div><div class="health-item-val" style="color:${scoreColor}">${score} pts</div></div>
  `;
}

function computeHealthScore(portfolio) {
  let score = 0;
  const n = portfolio.filter(p => numVal(p, 'Valeur (‚Ç¨)', 'valeur') > 0).length;
  if (n >= 5) score += 25; else if (n === 4) score += 18; else if (n === 3) score += 10;
  // ETF exclus du seuil de concentration (seuil ETF = 70%)
  const rouge = portfolio.filter(p => {
    const poids = numVal(p, 'Poids(%)', 'Poids (%)');
    return isETF(p) ? poids > 0.70 : poids > 0.20;
  }).length;
  if (rouge === 0) score += 25; else if (rouge === 1) score += 12;
  const withMarge = portfolio.filter(p => { const m = val(p, 'Marge de S√©curit√© (%)'); return m != null && m !== '' && m !== '--'; });
  const avgMarge = withMarge.length ? withMarge.reduce((a, p) => a + numVal(p, 'Marge de S√©curit√© (%)'), 0) / withMarge.length : 0;
  if (avgMarge > 0.2) score += 25; else if (avgMarge > 0.1) score += 18; else if (avgMarge > 0) score += 10;
  // maxPoids : ETF ignor√©s sauf si > 70%
  const maxPoids = portfolio.reduce((m, p) => {
    const poids = numVal(p, 'Poids(%)', 'Poids (%)');
    const effectif = isETF(p) ? Math.min(poids, 0.249) : poids; // ETF plafonn√© √† 24.9% pour le calcul
    return Math.max(m, effectif);
  }, 0);
  if (maxPoids < 0.25) score += 25; else if (maxPoids < 0.3) score += 18; else if (maxPoids < 0.35) score += 10; else if (maxPoids < 0.4) score += 5;
  return Math.min(100, score);
}

function getHealthLabel(score) {
  if (score >= 80) return 'üü¢ Portefeuille SOLIDE';
  if (score >= 65) return 'üü° Portefeuille CORRECT';
  if (score >= 50) return 'üü† Portefeuille FRAGILE';
  return 'üî¥ Portefeuille √Ä RISQUE';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABLE PORTFOLIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTable(portfolio) {
  const badge = document.getElementById('portfolio-count-badge');
  const tbody = document.getElementById('portfolio-tbody');
  if (!tbody) return;

  // S√©parer actifs et watchlist selon QT√â
  const actifs    = portfolio.filter(r => numVal(r, 'Quantit√©', 'quantite') > 0);
  const watchlist = portfolio.filter(r => numVal(r, 'Quantit√©', 'quantite') === 0);

  if (badge) badge.textContent = actifs.length + ' actifs ¬∑ ' + watchlist.length + ' en veille';

  actifs.sort((a, b) => numVal(b, 'Valeur (‚Ç¨)', 'valeur') - numVal(a, 'Valeur (‚Ç¨)', 'valeur'));

  tbody.innerHTML = '';

  // ‚îÄ‚îÄ BLOC 1 : positions actives ‚îÄ‚îÄ
  actifs.forEach(r => appendRow(tbody, r, false));

  // ‚îÄ‚îÄ S√âPARATEUR ‚îÄ‚îÄ
  if (watchlist.length > 0) {
    const sep = document.createElement('tr');
    sep.innerHTML = `
      <td colspan="11" style="
        padding: 8px 12px;
        font-size: 10px;
        letter-spacing: 2px;
        color: var(--text3);
        font-family: 'Space Mono', monospace;
        background: var(--surface2);
        border-top: 2px solid var(--border);
        border-bottom: 1px solid var(--border);
      ">‚Äî WATCHLIST ¬∑ EN SURVEILLANCE</td>
    `;
    tbody.appendChild(sep);
  }

  // ‚îÄ‚îÄ BLOC 2 : watchlist ‚îÄ‚îÄ
  watchlist.forEach(r => appendRow(tbody, r, true));
}

function appendRow(tbody, r, isWatchlist) {
  const pv      = numVal(r, 'PV (‚Ç¨)', 'pv');
  const pvPct   = numVal(r, 'PV (%)', 'pv_pct') * 100;
  const varJour = numVal(r, 'Var. Jour', 'var_jour') * 100;
  const poids   = numVal(r, 'Poids(%)', 'Poids (%)', 'poids') * 100;
  const signal  = String(val(r, 'Signal', 'signal') || '--');
  const ticker  = String(val(r, 'Ticker', 'ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
  const nom     = String(val(r, 'Nom', 'nom') || '');
  const qte     = numVal(r, 'Quantit√©', 'quantite');
  const pru     = numVal(r, 'PRU (‚Ç¨)', 'pru');
  const cours   = numVal(r, 'Cours (‚Ç¨)', 'cours');
  const valeur  = numVal(r, 'Valeur (‚Ç¨)', 'valeur');

  const pvClass  = pv >= 0 ? 'positive-text' : 'negative-text';
  const varClass = varJour >= 0 ? 'positive-text' : 'negative-text';
  const tickColor = isWatchlist ? 'color:var(--text3)' : '';

  const dash = '<span style="color:var(--text3)">‚Äî</span>';

  const tr = document.createElement('tr');
  if (isWatchlist) tr.style.cssText = 'opacity:0.45;';

  tr.innerHTML = `
    <td><span class="ticker-cell" style="${tickColor}">${escH(ticker)}</span></td>
    <td><span class="name-cell" title="${escH(nom)}">${escH(nom.substring(0,25))}${nom.length>25?'‚Ä¶':''}</span></td>
    <td class="num-cell">${isWatchlist ? dash : fmt(qte, 0)}</td>
    <td class="num-cell">${isWatchlist ? dash : fmt(pru) + ' ‚Ç¨'}</td>
    <td class="num-cell">${fmt(cours)} ‚Ç¨</td>
    <td class="num-cell ${varClass}">${varJour >= 0 ? '+' : ''}${varJour.toFixed(2)}%</td>
    <td class="num-cell">${isWatchlist ? dash : fmt(valeur) + ' ‚Ç¨'}</td>
    <td class="num-cell ${pvClass}">${isWatchlist ? dash : (pv >= 0 ? '+' : '') + fmt(pv) + ' ‚Ç¨'}</td>
    <td class="num-cell ${pvClass}">${isWatchlist ? dash : (pvPct >= 0 ? '+' : '') + pvPct.toFixed(2) + '%'}</td>
    <td>
      ${isWatchlist
        ? '<span style="color:var(--text3);font-size:10px;font-family:\'Space Mono\',monospace;letter-spacing:1px">VEILLE</span>'
        : `<div class="weight-bar-wrap">
            <div class="weight-bar"><div class="weight-bar-inner" style="width:${Math.min(poids*2,100)}%"></div></div>
            <span style="font-size:10px;font-family:'Space Mono',monospace;color:var(--text3)">${poids.toFixed(1)}%</span>
           </div>`
      }
    </td>
    <td>${renderSignal(signal)}</td>
  `;
  tbody.appendChild(tr);
}

function renderSignal(signal) {
  const s = (signal || '').toLowerCase();
  let cls = 'signal-neutral', icon = '‚ó¶';
  if (s.includes('fort achat'))        { cls = 'signal-buy';         icon = '‚ñ≤‚ñ≤'; }
  else if (s.includes('achat') || s.includes('buy')) { cls = 'signal-buy'; icon = '‚ñ≤'; }
  else if (s.includes('vente') || s.includes('sell')) { cls = 'signal-sell'; icon = '‚ñº'; }
  else if (s.includes('conserver') || s.includes('hold') || s.includes('neutre')) { cls = 'signal-hold'; icon = '‚óÜ'; }
  else if (s.includes('opportunit'))   { cls = 'signal-opportunity'; icon = '‚óà'; }
  else if (signal === '--')            return `<span class="signal signal-neutral">‚Äî</span>`;
  return `<span class="signal ${cls}">${icon} ${escH(signal)}</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts(secteurs, historique) {
  renderDonut(secteurs);
  renderHistorique(historique);
}

function renderDonut(secteurs) {
  const active = secteurs.filter(s => numVal(s, 'Valeur (‚Ç¨)') > 0 && String(val(s,'Secteur') || '') !== 'TOTAL');
  const labels = active.map(s => String(val(s, 'Secteur') || ''));
  const values = active.map(s => numVal(s, 'Valeur (‚Ç¨)'));

  if (donutChart) { donutChart.destroy(); donutChart = null; }
  const canvas = document.getElementById('donut-chart');
  if (!canvas) return;

  donutChart = new Chart(canvas.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: SECTOR_COLORS.slice(0, labels.length).map(c => c + 'cc'),
        borderColor: SECTOR_COLORS.slice(0, labels.length),
        borderWidth: 1,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117', borderColor: '#1e2d3d', borderWidth: 1,
          titleFont: { family: 'Space Mono' }, bodyFont: { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0', titleColor: '#00d4ff',
          callbacks: { label: ctx => ` ${ctx.label}: ${fmt(ctx.parsed)} ‚Ç¨ (${(ctx.parsed / values.reduce((a,b)=>a+b,0)*100).toFixed(1)}%)` }
        }
      }
    }
  });

  // Liste sectorielle
  const listEl = document.getElementById('sector-list');
  if (!listEl) return;
  listEl.innerHTML = '';
  active.forEach((s, i) => {
    const pv    = numVal(s, 'PV (‚Ç¨)');
    const poids = numVal(s, 'Poids (%)') * 100;
    const alert = String(val(s, '‚ö†Ô∏è Alerte') || '');
    const secteur = String(val(s, 'Secteur') || '');
    const isETFSector = /etf|index|tracker|indice|monde|world/i.test(secteur);
    const isSurexp = alert.includes('Surexpos√©') && !isETFSector;
    const alertColor = isSurexp ? 'var(--danger)' : alert.includes('Surveiller') && !isETFSector ? 'var(--warn)' : 'var(--accent2)';
    const alertLabel = isETFSector && alert.includes('Surexpos√©') ? '‚úì ETF OK' : alert;
    const div = document.createElement('div');
    div.className = 'sector-row';
    div.innerHTML = `
      <div class="sector-color" style="background:${SECTOR_COLORS[i] || '#888'}"></div>
      <div class="sector-name">${escH(String(val(s,'Secteur') || ''))}</div>
      <div class="sector-poids">${poids.toFixed(1)}%</div>
      <div class="sector-pv ${pv >= 0 ? 'positive-text' : 'negative-text'}">${pv >= 0 ? '+' : ''}${fmt(pv)} ‚Ç¨</div>
      <div class="sector-alert" style="color:${alertColor};border-color:${alertColor}33">${escH(alertLabel)}</div>
    `;
    listEl.appendChild(div);
  });
}

function renderHistorique(historique) {
  const badge = document.getElementById('hist-count-badge');
  const pts = historique
    .filter(r => (r['üìÖ Date'] || r['Date']) && (r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0) > 0)
    .map(r => ({
      date: new Date(r['üìÖ Date'] || r['Date']),
      val: parseFloat(r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0)
    }))
    .sort((a, b) => a.date - b.date);

  if (badge) badge.textContent = pts.length + ' points';
  if (historyChart) { historyChart.destroy(); historyChart = null; }
  const canvas = document.getElementById('history-chart');
  if (!canvas || pts.length === 0) return;

  const ctx = canvas.getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(0,212,255,0.2)');
  gradient.addColorStop(1, 'rgba(0,212,255,0)');

  historyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: pts.map(p => p.date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' })),
      datasets: [{
        label: 'Valeur (‚Ç¨)', data: pts.map(p => p.val),
        borderColor: '#00d4ff', backgroundColor: gradient,
        borderWidth: 2, pointRadius: pts.length > 20 ? 0 : 3,
        tension: 0.4, fill: true
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117', borderColor: '#1e2d3d', borderWidth: 1,
          titleFont: { family: 'Space Mono', size: 11 },
          bodyFont: { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0', titleColor: '#00d4ff',
          callbacks: { label: ctx => ` ${fmt(ctx.parsed.y)} ‚Ç¨` }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(30,45,61,0.5)' }, ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, maxTicksLimit: 8 } },
        y: { grid: { color: 'rgba(30,45,61,0.5)' }, ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, callback: v => fmt(v) + ' ‚Ç¨' } }
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WATCHLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWatchlist(watchlist) {
  const div = document.getElementById('watchlist-body');
  if (!div) return;
  if (!watchlist.length) {
    div.innerHTML = '<div style="padding:24px;color:var(--text3);font-size:13px;font-family:\'Space Mono\',monospace;">Aucune valeur en watchlist.</div>';
    return;
  }
  div.innerHTML = '';
  watchlist.forEach(r => {
    const ticker  = String(r['Indicateur'] || '--');
    const secteur = String(r['Valeur'] || '');
    const poids   = r['Max'] ? (parseFloat(r['Max']) * 100).toFixed(0) + '% max' : '';
    const statut  = '‚Äî Watchlist';
    const nom     = '';
    const d = document.createElement('div');
    d.className = 'watchlist-item';
    d.innerHTML = `
      <div class="wl-ticker">${escH(ticker)}</div>
      <div class="wl-name">${escH(nom)}</div>
      <div class="wl-status">${escH(secteur)}</div>
      <div class="wl-status">${escH(statut)}</div>
    `;
    div.appendChild(d);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALL_TABS = ['global', 'health', 'perf'];

function switchTab(name) {
  ALL_TABS.forEach(t => {
    const tabEl = document.getElementById('tab-' + t);
    const btnEl = document.getElementById('tab-btn-' + t);
    if (tabEl) tabEl.classList.toggle('active', t === name);
    if (btnEl) btnEl.classList.toggle('active', t === name);
  });
  if (name === 'perf' && _lastPortfolio) renderPerfView(_lastPortfolio, _lastHistorique);
  if (name === 'health' && _lastPortfolio) renderHealthTab(_lastPortfolio);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PORTFOLIO HEALTH TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _radarChart  = null;
let _healthFilter = 'all';
let _radarFilter  = 'all';

function filterHealth(cat) {
  _healthFilter = cat;
  ['all','action','etf'].forEach(c => {
    const b = document.getElementById('hf-btn-' + c);
    if (b) b.classList.toggle('active', c === cat);
  });
  if (_lastPortfolio) renderHealthCards(_lastPortfolio);
}

function filterRadar(cat) {
  _radarFilter = cat;
  ['all','action','etf'].forEach(c => {
    const b = document.getElementById('rr-btn-' + c);
    if (b) b.classList.toggle('active', c === cat);
  });
  if (_lastPortfolio) renderRadarChart(_lastPortfolio);
}

function isETF(r) {
  const sect = String(val(r,'Secteur','SECTEUR','secteur') || '').toLowerCase();
  const tick  = String(val(r,'Ticker','ticker') || '').toLowerCase();
  const nom   = String(val(r,'Nom','nom') || '').toLowerCase();
  return sect.includes('etf') || tick.includes('etf') || nom.includes('etf') || nom.includes('tracker') || nom.includes('amundi') || nom.includes('lyxor') || nom.includes('bnp easy') || nom.includes('ishares');
}

function computeScoreForRow(r, allActifs) {
  const pvPct  = numVal(r,'PV (%)','PV_PCT','pv_pct') * 100;
  const marge  = numVal(r,'Marge de S√©curit√© (%)','MARGE','marge') * 100;
  const poids  = numVal(r,'Poids(%)','POIDS','poids','Poids (%)') * 100;
  const signal = String(val(r,'Signal','SIGNAL','signal') || '').toLowerCase();
  const etf    = isETF(r);

  // ‚îÄ‚îÄ Nouvelles donn√©es fondamentales ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const per    = numVal(r,'PER','per');           // 0 = N/A / non dispo
  const mm50   = numVal(r,'MM50','mm50');         // 0 = non dispo
  const cours  = numVal(r,'Cours (‚Ç¨)','COURS','cours');

  // ‚îÄ‚îÄ Score Marge (0‚Äì35 pts) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const margeScore = Math.max(0, Math.min(35, marge * 1.75));

  // ‚îÄ‚îÄ Score PER (‚Äì8 / 0 / +8 pts) ‚Äî ignor√© si PER = 0 / N/A ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let perScore = 0;
  if (per > 0) {
    if (per < 15)       perScore = 8;   // Sous-√©valu√© ‚Üí bonus
    else if (per <= 25) perScore = 0;   // Correct     ‚Üí neutre
    else if (per <= 35) perScore = -4;  // Cher        ‚Üí malus mod√©r√©
    else                perScore = -8;  // Tr√®s cher   ‚Üí malus fort
  }

  // ‚îÄ‚îÄ Score MM50 (‚Äì7 / 0 / +7 pts) ‚Äî ignor√© si MM50 = 0 / non dispo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let mm50Score = 0;
  if (mm50 > 0 && cours > 0) {
    mm50Score = cours >= mm50 ? 7 : -7; // hausse ‚Üí bonus, baisse ‚Üí malus
  }

  // ‚îÄ‚îÄ Score PV% (0‚Äì20 pts) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pvScore = Math.max(0, Math.min(20, pvPct * 1.5));

  // ‚îÄ‚îÄ Malus surexposition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let concMalus = 0;
  if (!etf) {
    if (poids > 20)      concMalus = -20;  // Rouge
    else if (poids > 15) concMalus = -10;  // Orange
  } else {
    if (poids > 70)      concMalus = -15;  // Alerte ETF
  }

  let score = 0;
  if (etf) {
    // ETF : base 40 + marge PEA + PV + MM50 + PER + surexpo
    const avgMarge = allActifs.reduce((s, x) => s + numVal(x,'Marge de S√©curit√© (%)','MARGE','marge'), 0) / (allActifs.length || 1) * 100;
    score = 40 + Math.min(20, avgMarge * 1) + (pvPct > 0 ? 10 : 0) + mm50Score + perScore + concMalus;
  } else {
    // Action : composition multi-crit√®res
    score = pvScore + margeScore + perScore + mm50Score + concMalus;
  }

  return Math.min(100, Math.max(0, Math.round(score)));
}

function getSignalCategory(signal) {
  const s = (signal || '').toLowerCase();
  // Alerte surexposition ‚Üí traitement rouge / orange
  if (s.includes('alerte poids') || s.includes('alerte etf'))  return 'alert';
  if (s.includes('prudence'))                                    return 'watch';
  // Signaux standards (compatibles v4 et v5)
  if (s.includes('fort achat') || s.includes('opportunite') || s.includes('achat') || s.includes('buy')) return 'buy';
  if (s.includes('surevalue') || s.includes('sur√©val') || s.includes('vente') || s.includes('sell'))     return 'sell';
  if (s.includes('surveill') || s.includes('neutre') || s.includes('conserver') || s.includes('hold'))   return 'watch';
  return 'neutral';
}

function renderHealthTab(portfolio) {
  const actifs = portfolio.filter(r => numVal(r,'Quantit√©','quantite','QUANTITY') > 0);
  renderHealthCards(actifs);
  renderRadarChart(actifs);
  renderSignalCards(actifs);
}

function renderHealthCards(allActifs) {
  const grid = document.getElementById('health-score-grid');
  if (!grid) return;
  grid.innerHTML = '';

  let filtered = allActifs;
  if (_healthFilter === 'etf')    filtered = allActifs.filter(r => isETF(r));
  if (_healthFilter === 'action') filtered = allActifs.filter(r => !isETF(r));

  filtered.forEach(r => {
    const ticker  = String(val(r,'Ticker','ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    const nom     = String(val(r,'Nom','nom') || '');
    const pv      = numVal(r,'PV (‚Ç¨)','PV_EUR','pv');
    const pvPct   = numVal(r,'PV (%)','PV_PCT','pv_pct') * 100;
    const marge   = numVal(r,'Marge de S√©curit√© (%)','MARGE','marge') * 100;
    const poids   = numVal(r,'Poids(%)','POIDS','poids','Poids (%)') * 100;
    const per     = numVal(r,'PER','per');
    const mm50    = numVal(r,'MM50','mm50');
    const cours   = numVal(r,'Cours (‚Ç¨)','COURS','cours');
    const signal  = String(val(r,'Signal','SIGNAL','signal') || '');
    const etf     = isETF(r);
    const score   = computeScoreForRow(r, allActifs);

    // Surexposition warning
    const isOverExp = (!etf && poids > 15) || (etf && poids > 70);
    const isRedAlert = (!etf && poids > 20) || (etf && poids > 70);

    const scoreColor = score >= 75 ? 'var(--accent2)' : score >= 50 ? 'var(--warn)' : 'var(--danger)';
    const barGrad = score >= 75
      ? 'linear-gradient(90deg, #00ff9d, #00d4ff)'
      : score >= 50
        ? 'linear-gradient(90deg, #ffd166, #ff6b35)'
        : 'linear-gradient(90deg, #ef233c, #ff6b35)';

    // PER indicator
    const perColor = per > 0
      ? (per < 15 ? 'var(--accent2)' : per <= 25 ? 'var(--text2)' : 'var(--warn)')
      : 'var(--text3)';
    const perLabel = per > 0
      ? (per < 15 ? 'üü¢' : per <= 25 ? '‚ö™' : 'üü†') + ' ' + per.toFixed(1)
      : 'N/A';

    // MM50 indicator
    const mm50Arrow = (mm50 > 0 && cours > 0)
      ? (cours >= mm50 ? '‚ñ≤' : '‚ñº')
      : '‚Äî';
    const mm50Color = (mm50 > 0 && cours > 0)
      ? (cours >= mm50 ? 'var(--accent2)' : 'var(--danger)')
      : 'var(--text3)';

    const card = document.createElement('div');
    card.className = `health-score-card ${etf ? 'etf-card' : 'action-card'}`;
    card.innerHTML = `
      <div class="hsc-top">
        <div>
          <div class="hsc-ticker">${escH(ticker)}</div>
          <div class="hsc-name">${escH(nom.substring(0,28))}${nom.length>28?'‚Ä¶':''}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <span class="hsc-badge ${etf ? 'badge-shield' : 'badge-action'}">${etf ? 'üõ° SHIELD' : '‚óà ACTION'}</span>
          ${isOverExp ? `<span class="hsc-badge" style="color:${isRedAlert?'var(--danger)':'var(--warn)'};border-color:${isRedAlert?'rgba(239,35,60,0.4)':'rgba(255,209,102,0.4)'};background:${isRedAlert?'rgba(239,35,60,0.06)':'rgba(255,209,102,0.06)'}">‚ö† ${poids.toFixed(0)}%</span>` : ''}
        </div>
      </div>
      <div class="hsc-score-row">
        <div class="hsc-score-num" style="color:${scoreColor}">${score}</div>
        <div>
          <div class="hsc-score-label">/ 100</div>
          <div style="font-size:10px;font-family:'Space Mono',monospace;color:${scoreColor};margin-top:2px">
            ${score >= 75 ? '‚ñ≤ SOLIDE' : score >= 50 ? '‚óÜ CORRECT' : '‚ñº FRAGILE'}
          </div>
        </div>
      </div>
      <div class="hsc-bar-track">
        <div class="hsc-bar-fill" style="width:${score}%;background:${barGrad}"></div>
      </div>
      <div class="hsc-meta">
        <div class="hsc-meta-item">
          <span class="hsc-meta-label">PV%</span>
          <span class="hsc-meta-val" style="color:${pvPct>=0?'var(--accent2)':'var(--danger)'}">${pvPct>=0?'+':''}${pvPct.toFixed(1)}%</span>
        </div>
        <div class="hsc-meta-item">
          <span class="hsc-meta-label">Marge</span>
          <span class="hsc-meta-val" style="color:var(--accent)">${marge.toFixed(0)}%</span>
        </div>
        <div class="hsc-meta-item">
          <span class="hsc-meta-label">PER</span>
          <span class="hsc-meta-val" style="color:${perColor}">${perLabel}</span>
        </div>
        <div class="hsc-meta-item">
          <span class="hsc-meta-label">MM50</span>
          <span class="hsc-meta-val" style="color:${mm50Color}">${mm50Arrow}</span>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
}

function renderRadarChart(allActifs) {
  if (_radarChart) { _radarChart.destroy(); _radarChart = null; }
  const canvas = document.getElementById('radar-chart');
  if (!canvas) return;

  let filtered = allActifs;
  if (_radarFilter === 'etf')    filtered = allActifs.filter(r => isETF(r));
  if (_radarFilter === 'action') filtered = allActifs.filter(r => !isETF(r));
  if (!filtered.length) return;

  // Compute aggregated metrics (0‚Äì100 scale)
  const n = filtered.length;

  // 1. Diversification: penalise max concentration
  const poids = filtered.map(r => numVal(r,'Poids(%)','POIDS','poids','Poids (%)') * 100);
  const maxP  = Math.max(...poids);
  const diversif = Math.max(0, 100 - maxP * 2);

  // 2. Performance: average PV%
  const avgPvPct = filtered.reduce((s,r) => s + numVal(r,'PV (%)','PV_PCT','pv_pct') * 100, 0) / n;
  const perf = Math.max(0, Math.min(100, 50 + avgPvPct * 2));

  // 3. Marge de s√©curit√©: average
  const avgMarge = filtered.reduce((s,r) => s + numVal(r,'Marge de S√©curit√© (%)','MARGE','marge') * 100, 0) / n;
  const margeScore = Math.max(0, Math.min(100, avgMarge * 3));

  // 4. Force du signal
  const signalStrength = filtered.reduce((s, r) => {
    const sig = (val(r,'Signal','SIGNAL','signal') || '').toLowerCase();
    if (sig.includes('alerte'))  return s + 0;    // surexpo rouge ‚Üí 0
    if (sig.includes('fort achat')) return s + 100;
    if (sig.includes('opportunite') || sig.includes('achat') || sig.includes('buy')) return s + 75;
    if (sig.includes('neutre') || sig.includes('hold')) return s + 45;
    if (sig.includes('surveiller') || sig.includes('prudence')) return s + 20;
    if (sig.includes('surevalue') || sig.includes('vente') || sig.includes('sell')) return s + 5;
    return s + 30;
  }, 0) / n;

  // 5. Sant√© globale: average score
  const avgScore = filtered.reduce((s,r) => s + computeScoreForRow(r, allActifs), 0) / n;

  // 6. Valorisation PER (0-100 : 100 = tous sous-√©valu√©s, 0 = tous tr√®s chers)
  const rowsWithPer = filtered.filter(r => numVal(r,'PER','per') > 0);
  const valorisation = rowsWithPer.length > 0
    ? rowsWithPer.reduce((s, r) => {
        const per = numVal(r,'PER','per');
        return s + (per < 15 ? 100 : per <= 25 ? 65 : per <= 35 ? 35 : 10);
      }, 0) / rowsWithPer.length
    : 50; // neutre si aucun PER dispo

  _radarChart = new Chart(canvas.getContext('2d'), {
    type: 'radar',
    data: {
      labels: ['Diversification', 'Performance', 'Marge S√©cu.', 'Force Signal', 'Score Global', 'Valorisation'],
      datasets: [{
        label: _radarFilter === 'etf' ? 'ETF' : _radarFilter === 'action' ? 'Actions' : 'Portefeuille',
        data: [diversif, perf, margeScore, signalStrength, avgScore, valorisation],
        borderColor: _radarFilter === 'etf' ? '#ffd166' : '#00d4ff',
        backgroundColor: _radarFilter === 'etf' ? 'rgba(255,209,102,0.1)' : 'rgba(0,212,255,0.08)',
        pointBackgroundColor: _radarFilter === 'etf' ? '#ffd166' : '#00d4ff',
        pointRadius: 4,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          labels: { color: '#8fa3b8', font: { family: 'Space Mono', size: 10 } }
        },
        tooltip: {
          backgroundColor: '#0d1117', borderColor: '#1e2d3d', borderWidth: 1,
          titleFont: { family: 'Space Mono' }, bodyFont: { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0', titleColor: '#00d4ff',
          callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.r.toFixed(0)}/100` }
        }
      },
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { display: false, stepSize: 25 },
          grid: { color: 'rgba(30,45,61,0.6)' },
          angleLines: { color: 'rgba(30,45,61,0.6)' },
          pointLabels: {
            color: '#8fa3b8',
            font: { family: 'Space Mono', size: 10 }
          }
        }
      }
    }
  });
}

function renderSignalCards(actifs) {
  const feed  = document.getElementById('signal-log-feed');
  const count = document.getElementById('signal-log-count');
  if (!feed) return;
  feed.innerHTML = '';

  const now = new Date();
  const timeStr = now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });

  const rows = [...actifs].filter(r => {
    const sig = String(val(r,'Signal','SIGNAL','signal') || '');
    return sig && sig !== '--' && sig !== '';
  });

  if (count) count.textContent = rows.length + ' signaux';

  rows.forEach(r => {
    const ticker  = String(val(r,'Ticker','ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    const nom     = String(val(r,'Nom','nom') || ticker);
    const signal  = String(val(r,'Signal','SIGNAL','signal') || '');
    const marge   = numVal(r,'Marge de S√©curit√© (%)','MARGE','marge') * 100;
    const pvPct   = numVal(r,'PV (%)','PV_PCT','pv_pct') * 100;
    const per     = numVal(r,'PER','per');
    const mm50    = numVal(r,'MM50','mm50');
    const cours   = numVal(r,'Cours (‚Ç¨)','COURS','cours');
    const poids   = numVal(r,'Poids(%)','POIDS','poids','Poids (%)') * 100;
    const cat     = getSignalCategory(signal);
    const etf     = isETF(r);

    // ‚îÄ‚îÄ Indicateurs compl√©mentaires (PER + MM50) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const perBadge = per > 0
      ? `<span style="margin-left:8px;font-size:9px;padding:2px 6px;border:1px solid;font-family:'Space Mono',monospace;
             ${per < 15 ? 'color:var(--accent2);border-color:rgba(0,255,157,0.4)' :
               per <= 25 ? 'color:var(--text3);border-color:var(--border)' :
                           'color:var(--warn);border-color:rgba(255,209,102,0.4)'}">
             PER ${per.toFixed(1)}</span>`
      : '';
    const trendIcon = (mm50 > 0 && cours > 0)
      ? (cours >= mm50
          ? `<span style="color:var(--accent2);font-size:10px;margin-left:6px">‚ñ≤ MM50</span>`
          : `<span style="color:var(--danger);font-size:10px;margin-left:6px">‚ñº MM50</span>`)
      : '';

    let levelLabel, levelClass, cardClass, logText, recText, recClass;

    if (cat === 'alert') {
      // Surexposition ‚Äî priorit√© absolue
      const isRouge = signal.toLowerCase().includes('alerte');
      levelLabel = isRouge ? 'ALERTE' : 'PRUDENCE';
      levelClass = isRouge ? 'lvl-sell' : 'lvl-watch';
      cardClass  = isRouge ? 'sc-sell'  : 'sc-watch';
      logText = `[ALERT] <span class="sc-ticker-ref">$${escH(ticker)}</span> ‚Äî <span class="${isRouge?'sc-value-sell':'sc-value-watch'}">Surexposition ${poids.toFixed(1)}%</span>`;
      recText = isRouge
        ? `‚Üí RECOMMANDATION : ALL√âGER IMP√âRATIVEMENT (>${isETF(r)?'70':'20'}% du PEA)`
        : `‚Üí RECOMMANDATION : SURVEILLER LA CONCENTRATION (>${isETF(r)?'70':'15'}%)`;
      recClass = isRouge ? 'sell-rec' : 'watch-rec';
    } else if (cat === 'buy') {
      levelLabel = signal.toLowerCase().includes('fort') ? 'STRONG BUY' : 'BUY';
      levelClass = 'lvl-buy'; cardClass = 'sc-buy';
      const margeStr = marge > 0
        ? `Marge de s√©curit√© <span class="sc-value-buy">${marge.toFixed(0)}%</span>`
        : `PV actuelle <span class="sc-value-buy">${pvPct>=0?'+':''}${pvPct.toFixed(1)}%</span>`;
      logText = `[INFO] <span class="sc-ticker-ref">$${escH(ticker)}</span> ‚Äî ${margeStr}`;
      recText = `‚Üí RECOMMANDATION : ${signal.toLowerCase().includes('fort') ? 'ACCUMULER FORTEMENT' : 'ACCUMULER'}`;
      recClass = 'buy-rec';
    } else if (cat === 'sell') {
      levelLabel = 'SUR√âV.';
      levelClass = 'lvl-sell'; cardClass = 'sc-sell';
      logText = `[WARN] <span class="sc-ticker-ref">$${escH(ticker)}</span> ‚Äî <span class="sc-value-sell">Signal de vente d√©tect√©</span>. PV: ${pvPct>=0?'+':''}${pvPct.toFixed(1)}%`;
      recText = `‚Üí RECOMMANDATION : R√âDUIRE LA POSITION`;
      recClass = 'sell-rec';
    } else if (cat === 'watch') {
      levelLabel = signal.toLowerCase().includes('prudence') ? 'PRUDENCE' : 'WATCH';
      levelClass = 'lvl-watch'; cardClass = 'sc-watch';
      logText = `[INFO] <span class="sc-ticker-ref">$${escH(ticker)}</span> ‚Äî <span class="sc-value-watch">Surveillance active</span>. ${marge > 0 ? `Marge: ${marge.toFixed(0)}%` : `PV: ${pvPct>=0?'+':''}${pvPct.toFixed(1)}%`}`;
      recText = `‚Üí RECOMMANDATION : SURVEILLER ‚Äî ${escH(signal)}`;
      recClass = 'watch-rec';
    } else {
      levelLabel = 'NEUTRE';
      levelClass = 'lvl-neutral'; cardClass = 'sc-neutral';
      logText = `[LOG] <span class="sc-ticker-ref">$${escH(ticker)}</span> ‚Äî Pas de signal fort. PV: ${pvPct>=0?'+':''}${pvPct.toFixed(1)}%`;
      recText = '';
      recClass = '';
    }

    const card = document.createElement('div');
    card.className = `signal-card ${cardClass}`;
    card.innerHTML = `
      <div class="sc-header">
        <span class="sc-timestamp">${timeStr}</span>
        <span class="sc-level ${levelClass}">${levelLabel}</span>
        ${etf ? '<span class="sc-level" style="color:var(--warn);border-color:rgba(255,209,102,0.4);background:rgba(255,209,102,0.06)">üõ° ETF</span>' : ''}
        ${perBadge}
        ${trendIcon}
      </div>
      <div class="sc-log-line">${logText} ‚Äî <span style="color:var(--text3)">${escH(nom.substring(0,32))}</span></div>
      ${recText ? `<div class="sc-rec ${recClass}">${recText}</div>` : ''}
    `;
    feed.appendChild(card);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MONETARY PERF TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _monetaryEquityChart = null;
let _currentMonTf = 'ALL';

function setMonTimeframe(tf) {
  _currentMonTf = tf;
  document.querySelectorAll('#tab-monetary .tf-btn').forEach(b => b.classList.toggle('active', b.textContent === tf));
  if (_lastHistorique) renderMonEquityCurve(_lastHistorique, tf);
}

function renderMonetaryTab(portfolio, historique) {
  const actifs = portfolio.filter(r => numVal(r,'Quantit√©','quantite','QUANTITY') > 0);
  renderMonEquityCurve(historique, _currentMonTf);
  renderFluxTable(actifs);
}

function renderMonEquityCurve(historique, tf) {
  if (_monetaryEquityChart) { _monetaryEquityChart.destroy(); _monetaryEquityChart = null; }
  const canvas = document.getElementById('monetary-equity-chart');
  if (!canvas) return;

  const allPts = historique
    .filter(r => (r['üìÖ Date'] || r['Date']) && parseFloat(r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0) > 0)
    .map(r => ({
      date: new Date(r['üìÖ Date'] || r['Date']),
      val:  parseFloat(r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0)
    }))
    .sort((a,b) => a.date - b.date);

  const pts = filterByTimeframe(allPts, tf);
  if (!pts.length) return;

  let ath = 0, athIdx = 0;
  pts.forEach((p,i) => { if (p.val > ath) { ath = p.val; athIdx = i; } });
  const lastVal = pts[pts.length - 1].val;
  const drawdown = ath > 0 ? ((lastVal - ath) / ath * 100) : 0;

  // Stress level
  const absDD = Math.abs(drawdown);
  let stressClass = 'stress-low', stressLabel = '‚ñ≤ STRESS LOW', stressIcon = '‚óà';
  if (absDD > 10) { stressClass = 'stress-high'; stressLabel = '‚ö† STRESS HIGH'; stressIcon = '‚ñº'; }
  else if (absDD > 3) { stressClass = 'stress-medium'; stressLabel = '‚óÜ STRESS MEDIUM'; stressIcon = '‚óÜ'; }

  const athB = document.getElementById('mon-ath-badge');
  const stB  = document.getElementById('mon-stress-badge');
  if (athB) { athB.style.display = 'inline-flex'; athB.textContent = '‚óÜ ATH: ' + fmt(ath) + ' ‚Ç¨'; }
  if (stB)  {
    stB.style.display = 'inline-flex';
    stB.className = 'stress-badge ' + stressClass;
    stB.textContent = stressIcon + ' ' + stressLabel + ' ' + drawdown.toFixed(2) + '%';
  }

  const ctx = canvas.getContext('2d');
  const gradMain = ctx.createLinearGradient(0, 0, 0, 380);
  gradMain.addColorStop(0, 'rgba(0, 212, 255, 0.2)');
  gradMain.addColorStop(1, 'rgba(0, 212, 255, 0)');

  const ddData = pts.map((p,i) => i >= athIdx ? ath : null);
  const labels  = pts.map(p => p.date.toLocaleDateString('fr-FR', { day:'2-digit', month:'short' }));
  const values  = pts.map(p => p.val);

  _monetaryEquityChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Zone Drawdown',
          data: ddData,
          borderColor: 'transparent',
          backgroundColor: 'rgba(239,35,60,0.08)',
          fill: { target: { value: lastVal }, above: 'rgba(239,35,60,0.08)', below: 'transparent' },
          pointRadius: 0, tension: 0, order: 2
        },
        {
          label: 'Valeur (‚Ç¨)',
          data: values,
          borderColor: '#00d4ff',
          backgroundColor: gradMain,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 7,
          pointHoverBackgroundColor: 'transparent',
          pointHoverBorderColor: '#00d4ff',
          pointHoverBorderWidth: 2,
          tension: 0.4, fill: true, order: 1
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117', borderColor: '#1e2d3d', borderWidth: 1,
          titleFont: { family: 'Space Mono', size: 11 },
          bodyFont: { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0', titleColor: '#00d4ff',
          filter: item => item.datasetIndex === 1,
          callbacks: {
            label: ctx => ` ${fmt(ctx.parsed.y)} ‚Ç¨`,
            afterLabel: ctx => {
              const d = ctx.parsed.y - ath;
              return d < 0 ? ` ‚ñº ${fmt(d)} ‚Ç¨ vs ATH (${((d/ath)*100).toFixed(2)}%)` : '';
            }
          }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(30,45,61,0.4)' }, ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, maxTicksLimit: 10 } },
        y: { grid: { color: 'rgba(30,45,61,0.4)' }, ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, callback: v => fmt(v,0) + ' ‚Ç¨' } }
      }
    },
    plugins: [{
      id: 'monAthLine',
      afterDraw(chart) {
        if (!pts.length) return;
        const { ctx: c, scales: { y } } = chart;
        const yPos = y.getPixelForValue(ath);
        c.save();
        c.setLineDash([5, 5]);
        c.strokeStyle = 'rgba(255,209,102,0.5)';
        c.lineWidth = 1;
        c.beginPath();
        c.moveTo(chart.chartArea.left, yPos);
        c.lineTo(chart.chartArea.right, yPos);
        c.stroke();
        c.fillStyle = 'rgba(255,209,102,0.85)';
        c.font = '9px Space Mono';
        c.fillText('ATH', chart.chartArea.right + 4, yPos + 3);
        c.restore();
      }
    }]
  });
}

function renderFluxTable(actifs) {
  const tbody = document.getElementById('flux-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const totalPV = actifs.reduce((s,r) => s + numVal(r,'PV (‚Ç¨)','PV_EUR','pv'), 0);
  const absTotalPV = Math.abs(totalPV) || 1;

  const sorted = [...actifs].sort((a,b) => Math.abs(numVal(b,'PV (‚Ç¨)','PV_EUR','pv')) - Math.abs(numVal(a,'PV (‚Ç¨)','PV_EUR','pv')));

  sorted.forEach(r => {
    const ticker  = String(val(r,'Ticker','ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    const nom     = String(val(r,'Nom','nom') || '');
    const pv      = numVal(r,'PV (‚Ç¨)','PV_EUR','pv');
    const contribPct = Math.min(100, Math.abs(pv) / absTotalPV * 100);
    const pvClass    = pv >= 0 ? 'positive-text' : 'negative-text';
    const barColor   = pv >= 0 ? 'var(--accent2)' : 'var(--danger)';

    const row = document.createElement('div');
    row.className = 'flux-tr';
    row.innerHTML = `
      <div class="flux-nom">${escH(ticker)}</div>
      <div class="flux-name-full" title="${escH(nom)}">${escH(nom.substring(0,40))}${nom.length>40?'‚Ä¶':''}</div>
      <div class="flux-pv ${pvClass}">${pv>=0?'+':''}${fmt(pv)} ‚Ç¨</div>
      <div class="flux-bar-cell">
        <div class="flux-bar-track">
          <div class="flux-bar-fill" style="width:${contribPct}%;background:${barColor}"></div>
        </div>
        <div class="flux-bar-pct" style="color:${barColor}">${contribPct.toFixed(1)}% de la PV totale</div>
      </div>
    `;
    tbody.appendChild(row);
  });
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PERFORMANCE VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _lastPortfolio  = null;
let _lastHistorique = [];
let _equityChart    = null;
let _currentTf      = 'ALL';

// Called from renderDashboard ‚Äî store data for perf view
function storePerfData(portfolio, historique) {
  _lastPortfolio  = portfolio.filter(r => numVal(r, 'Quantit√©', 'quantite') > 0);
  _lastHistorique = historique;
}

function renderPerfView(portfolio, historique) {
  const actifs = portfolio;

  // ‚îÄ‚îÄ Totaux pour sticky header
  let totalVal = 0, totalPV = 0;
  actifs.forEach(r => {
    totalVal += numVal(r, 'Valeur (‚Ç¨)', 'valeur');
    totalPV  += numVal(r, 'PV (‚Ç¨)', 'pv');
  });
  const pvPct = totalVal > 0 ? (totalPV / (totalVal - totalPV)) * 100 : 0;
  const isPos = totalPV >= 0;

  const elV   = document.getElementById('ps-valeur');
  const elPe  = document.getElementById('ps-pv-eur');
  const elPp  = document.getElementById('ps-pv-pct');
  if (elV)  elV.textContent  = fmt(totalVal) + ' ‚Ç¨';
  if (elPe) { elPe.textContent = (isPos ? '+' : '') + fmt(totalPV) + ' ‚Ç¨'; elPe.style.color = isPos ? 'var(--accent2)' : 'var(--danger)'; }
  if (elPp) { elPp.textContent = (isPos ? '+' : '') + pvPct.toFixed(2) + '%'; elPp.style.color = isPos ? 'var(--accent2)' : 'var(--danger)'; }

  let best = null, worst = null;
  actifs.forEach(r => {
    const p = numVal(r, 'PV (%)', 'pv_pct') * 100;
    const n = String(val(r,'Ticker','ticker')||'').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    if (!best || p > best.p)  best  = { n, p };
    if (!worst || p < worst.p) worst = { n, p };
  });
  const elB = document.getElementById('ps-best');
  const elW = document.getElementById('ps-worst');
  if (elB && best)  elB.textContent  = best.n  + ' (' + (best.p  >= 0 ? '+' : '') + best.p.toFixed(1)  + '%)';
  if (elW && worst) elW.textContent  = worst.n + ' (' + (worst.p >= 0 ? '+' : '') + worst.p.toFixed(1) + '%)';

  // ‚îÄ‚îÄ Performance Ledger Table
  renderPerfTable(actifs, totalPV);

  // ‚îÄ‚îÄ Equity Curve
  renderEquityCurve(historique, _currentTf);
}

function renderPerfTable(actifs, totalPV) {
  const tbody = document.getElementById('perf-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  // Sort by |PV‚Ç¨| descending
  const sorted = [...actifs].sort((a, b) => Math.abs(numVal(b,'PV (‚Ç¨)','pv')) - Math.abs(numVal(a,'PV (‚Ç¨)','pv')));

  sorted.forEach(r => {
    const pv      = numVal(r, 'PV (‚Ç¨)', 'pv');
    const pvPct   = numVal(r, 'PV (%)', 'pv_pct') * 100;
    const varJour = numVal(r, 'Var. Jour', 'var_jour') * 100;
    const pru     = numVal(r, 'PRU (‚Ç¨)', 'pru');
    const cours   = numVal(r, 'Cours (‚Ç¨)', 'cours');
    const signal  = String(val(r, 'Signal', 'signal') || '--');
    const ticker  = String(val(r, 'Ticker', 'ticker') || '').replace('EPA:','').replace('ETR:','').replace('NASDAQ:','');
    const nom     = String(val(r, 'Nom', 'nom') || '');

    const pvClass  = pv >= 0 ? 'positive-text' : 'negative-text';
    const varClass = varJour >= 0 ? 'positive-text' : 'negative-text';

    // Contribution = part de cette PV dans la PV totale absolue
    const absTotalPV = Math.abs(totalPV) || 1;
    const contribPct = Math.min(100, Math.abs(pv) / absTotalPV * 100);
    const contribColor = pv >= 0 ? '#00ff9d' : '#ef233c';

    // Sparkline SVG (simulation bas√©e sur PRU vs cours avec variation al√©atoire coh√©rente)
    const sparkSvg = buildSparkline(pru, cours, ticker);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="ticker-cell">${escH(ticker)}</span></td>
      <td><span class="name-cell" title="${escH(nom)}">${escH(nom.substring(0,22))}${nom.length>22?'‚Ä¶':''}</span></td>
      <td class="num-cell">${fmt(cours)} ‚Ç¨</td>
      <td class="num-cell" style="color:var(--text3)">${fmt(pru)} ‚Ç¨</td>
      <td class="num-cell ${varClass}">${varJour >= 0 ? '+' : ''}${varJour.toFixed(2)}%</td>
      <td class="num-cell ${pvClass}">${pv >= 0 ? '+' : ''}${fmt(pv)} ‚Ç¨</td>
      <td class="num-cell ${pvClass}">${pvPct >= 0 ? '+' : ''}${pvPct.toFixed(2)}%</td>
      <td class="num-cell contrib-cell">
        <div class="contrib-bar-bg" style="width:${contribPct}%;background:${contribColor}"></div>
        <div class="contrib-val ${pvClass}">${pv >= 0 ? '+' : ''}${fmt(pv)} ‚Ç¨
          <span style="font-size:9px;color:var(--text3);margin-left:4px">${contribPct.toFixed(0)}%</span>
        </div>
      </td>
      <td class="sparkline-cell" style="text-align:center">${sparkSvg}</td>
      <td>${renderSignal(signal)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function buildSparkline(pru, cours, seed) {
  // Generate a coherent 7-point sparkline seeded by ticker name
  const isGain = cours >= pru;
  const color  = isGain ? '#00ff9d' : '#ef233c';
  const W = 80, H = 28, pts = 7;

  // Pseudo-random seeded by ticker characters
  let hash = 0;
  for (let i = 0; i < seed.length; i++) hash = (hash * 31 + seed.charCodeAt(i)) & 0xffffffff;
  const rng = () => { hash = (hash * 1664525 + 1013904223) & 0xffffffff; return (hash >>> 0) / 0xffffffff; };

  // Build values: start near PRU, end near cours
  const start = pru;
  const end   = cours;
  const values = [];
  for (let i = 0; i < pts; i++) {
    const t    = i / (pts - 1);
    const base = start + (end - start) * t;
    const noise = (rng() - 0.5) * Math.abs(end - start) * 0.4;
    values.push(base + noise);
  }
  values[pts - 1] = end; // anchor last point

  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const range = maxV - minV || 1;

  const toX = i => (i / (pts - 1)) * (W - 4) + 2;
  const toY = v => H - 4 - ((v - minV) / range) * (H - 8);

  let d = `M ${toX(0)} ${toY(values[0])}`;
  for (let i = 1; i < pts; i++) {
    const x0 = toX(i - 1), y0 = toY(values[i - 1]);
    const x1 = toX(i),     y1 = toY(values[i]);
    const cx  = (x0 + x1) / 2;
    d += ` C ${cx} ${y0} ${cx} ${y1} ${x1} ${y1}`;
  }

  // Area fill path
  const areaD = d + ` L ${toX(pts-1)} ${H} L ${toX(0)} ${H} Z`;

  return `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
    <defs>
      <linearGradient id="sg-${seed}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <path d="${areaD}" fill="url(#sg-${seed})"/>
    <path d="${d}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/>
    <circle cx="${toX(pts-1)}" cy="${toY(values[pts-1])}" r="2.5" fill="${color}" opacity="0.9"/>
  </svg>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EQUITY CURVE WITH DRAWDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTimeframe(tf) {
  _currentTf = tf;
  document.querySelectorAll('.tf-btn').forEach(b => b.classList.toggle('active', b.textContent === tf));
  if (_lastHistorique) renderEquityCurve(_lastHistorique, tf);
}

function filterByTimeframe(pts, tf) {
  if (!pts.length || tf === 'ALL') return pts;
  const last = pts[pts.length - 1].date;
  const now  = new Date(last);
  let cutoff;
  if (tf === '1M')  { cutoff = new Date(now); cutoff.setMonth(cutoff.getMonth() - 1); }
  if (tf === '3M')  { cutoff = new Date(now); cutoff.setMonth(cutoff.getMonth() - 3); }
  if (tf === '6M')  { cutoff = new Date(now); cutoff.setMonth(cutoff.getMonth() - 6); }
  if (tf === 'YTD') { cutoff = new Date(now.getFullYear(), 0, 1); }
  return pts.filter(p => p.date >= cutoff);
}

function renderEquityCurve(historique, tf) {
  if (_equityChart) { _equityChart.destroy(); _equityChart = null; }
  const canvas = document.getElementById('equity-chart');
  if (!canvas) return;

  const allPts = historique
    .filter(r => (r['üìÖ Date'] || r['Date']) && (r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0) > 0)
    .map(r => ({
      date: new Date(r['üìÖ Date'] || r['Date']),
      val:  parseFloat(r['üí∂ Valeur Totale (‚Ç¨)'] || r['Valeur Totale'] || 0)
    }))
    .sort((a, b) => a.date - b.date);

  const pts = filterByTimeframe(allPts, tf);
  if (!pts.length) return;

  // Compute ATH and drawdown
  let ath = 0, athIdx = 0;
  pts.forEach((p, i) => { if (p.val > ath) { ath = p.val; athIdx = i; } });
  const lastVal = pts[pts.length - 1].val;
  const drawdown = ath > 0 ? ((lastVal - ath) / ath * 100) : 0;

  const athBadge = document.getElementById('ath-badge');
  const ddBadge  = document.getElementById('dd-badge');
  if (athBadge) { athBadge.style.display = 'flex'; athBadge.textContent = '‚óÜ ATH: ' + fmt(ath) + ' ‚Ç¨'; }
  if (ddBadge)  { ddBadge.style.display  = 'flex'; ddBadge.textContent  = '‚ñº DD: ' + drawdown.toFixed(2) + '%'; }

  const ctx = canvas.getContext('2d');

  // Main gradient fill
  const gradMain = ctx.createLinearGradient(0, 0, 0, 380);
  gradMain.addColorStop(0, 'rgba(0, 212, 255, 0.18)');
  gradMain.addColorStop(1, 'rgba(0, 212, 255, 0)');

  // Drawdown zone data: only from ATH point onward, capped at ATH value
  const ddData = pts.map((p, i) => i >= athIdx ? ath : null);

  const labels  = pts.map(p => p.date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }));
  const values  = pts.map(p => p.val);

  _equityChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Drawdown Zone',
          data: ddData,
          borderColor: 'transparent',
          backgroundColor: 'rgba(239, 35, 60, 0.08)',
          fill: { target: { value: lastVal }, above: 'rgba(239, 35, 60, 0.08)', below: 'transparent' },
          pointRadius: 0,
          tension: 0,
          order: 2
        },
        {
          label: 'Valeur (‚Ç¨)',
          data: values,
          borderColor: '#00d4ff',
          backgroundColor: gradMain,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 6,
          pointHoverBackgroundColor: 'transparent',
          pointHoverBorderColor: '#00d4ff',
          pointHoverBorderWidth: 2,
          tension: 0.35,
          fill: true,
          order: 1
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0d1117',
          borderColor: '#1e2d3d',
          borderWidth: 1,
          titleFont: { family: 'Space Mono', size: 11 },
          bodyFont:  { family: 'Space Mono', size: 11 },
          bodyColor: '#e2e8f0',
          titleColor: '#00d4ff',
          filter: item => item.datasetIndex === 1,
          callbacks: {
            label: ctx => ` ${fmt(ctx.parsed.y)} ‚Ç¨`,
            afterLabel: ctx => {
              const delta = ctx.parsed.y - ath;
              if (delta < 0) return ` ‚ñº ${fmt(delta)} ‚Ç¨ vs ATH`;
              return '';
            }
          }
        },
        // ATH annotation line via custom plugin
        annotation: undefined
      },
      scales: {
        x: {
          grid: { color: 'rgba(30,45,61,0.4)' },
          ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, maxTicksLimit: 10 }
        },
        y: {
          grid: { color: 'rgba(30,45,61,0.4)' },
          ticks: { color: '#4a6279', font: { family: 'Space Mono', size: 10 }, callback: v => fmt(v, 0) + ' ‚Ç¨' }
        }
      }
    },
    plugins: [{
      id: 'athLine',
      afterDraw(chart) {
        if (!pts.length) return;
        const { ctx: c, scales: { y } } = chart;
        const yPos = y.getPixelForValue(ath);
        c.save();
        c.setLineDash([4, 4]);
        c.strokeStyle = 'rgba(255,209,102,0.4)';
        c.lineWidth = 1;
        c.beginPath();
        c.moveTo(chart.chartArea.left, yPos);
        c.lineTo(chart.chartArea.right, yPos);
        c.stroke();
        c.fillStyle = 'rgba(255,209,102,0.8)';
        c.font = '9px Space Mono';
        c.fillText('ATH', chart.chartArea.right + 4, yPos + 3);
        c.restore();
      }
    }]
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HOOK INTO renderDashboard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origRenderDashboard = renderDashboard;
renderDashboard = function(json) {
  _origRenderDashboard(json);
  const EXCLUS = ['TOTAL PORTEFEUILLE', 'TOTAL', 'Diagnostic Rapide', 'Score Sant√©'];
  const portfolio = (json['PORTFOLIO'] || []).filter(r => {
    const t = String(val(r,'Ticker','ticker')||'').trim();
    if (!t) return false;
    if (EXCLUS.some(ex => t.includes(ex))) return false;
    if (/^\d+$/.test(t)) return false;
    const nom = String(val(r,'Nom','nom')||'').trim();
    if (!nom && !/^(EPA|ETR|NASDAQ|NYSE|AMS|BIT|SWX):/i.test(t)) return false;
    return numVal(r,'Cours (‚Ç¨)','cours') > 0;
  });
  storePerfData(portfolio, json['Historique_Patrimoine'] || []);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAWER SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDrawer(tab) {
  const drawer = document.getElementById(tab + '-drawer');
  const btn    = document.getElementById(tab + '-drawer-btn');
  if (!drawer) return;
  const isOpen = drawer.classList.toggle('open');
  if (btn) btn.classList.toggle('open', isOpen);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BENTO GRID ‚Äî Smart Diversification
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderBentoGrid(portfolio) {
  const container = document.getElementById('bento-container');
  if (!container) return;

  // Agr√©gation par secteur (actifs uniquement)
  const sectors = {};
  let grandTotal = 0;

  portfolio.filter(r => numVal(r,'Quantit√©','quantite') > 0).forEach(r => {
    const sName = String(val(r,'Secteur','secteur') || 'Inconnu').trim();
    const v     = numVal(r,'Valeur (‚Ç¨)','valeur');
    if (!sectors[sName]) {
      sectors[sName] = {
        name   : sName,
        total  : 0,
        isETF  : /etf|index|tracker|indice/i.test(sName),
      };
    }
    sectors[sName].total += v;
    grandTotal += v;
  });

  if (grandTotal === 0) {
    container.innerHTML = '<div style="color:var(--text3);font-family:\'Space Mono\',monospace;font-size:12px;padding:16px">Aucune donn√©e sectorielle.</div>';
    return;
  }

  container.innerHTML = Object.values(sectors)
    .sort((a, b) => b.total - a.total)
    .map(s => {
      const weight   = (s.total / grandTotal) * 100;
      const isWarn   = !s.isETF && weight > 20;
      const isETFWarn = s.isETF && weight > 70;
      const spanCls  = weight > 30 ? 'span2' : '';
      const cardCls  = s.isETF ? (isETFWarn ? 'is-warn' : 'is-etf') : isWarn ? 'is-warn' : '';
      const badge    = s.isETF
        ? (isETFWarn
            ? '<span class="warn-badge">‚ö† Surexpos√©</span>'
            : '<span class="etf-badge">‚úì ETF / Index</span>')
        : isWarn ? '<span class="warn-badge">‚ö† Surexpos√©</span>' : '';

      return `
        <div class="bento-card ${cardCls} ${spanCls}">
          ${badge}
          <div class="bento-sector-label">${escH(s.name)}</div>
          <div class="bento-weight-val">${weight.toFixed(1)}<span style="font-size:1rem;opacity:.6">%</span></div>
          <div class="bento-valeur">${fmt(s.total)} ‚Ç¨</div>
          <div class="bento-progress-bg" style="width:${Math.min(weight * 2, 100)}%"></div>
        </div>`;
    }).join('');
}

// Hook : Bento lanc√© depuis l'onglet Sant√©
const _origRenderHealthTab = renderHealthTab;
renderHealthTab = function(portfolio) {
  _origRenderHealthTab(portfolio);
  renderBentoGrid(portfolio);
};

// Hook perf view conserv√©
const _origRenderPerfView = renderPerfView;
renderPerfView = function(portfolio, historique) {
  _origRenderPerfView(portfolio, historique);
  const set = (id, el) => { const e = document.getElementById(id); if (e && el) e.textContent = el; };
  set('pd-valeur', document.getElementById('ps-valeur') ? document.getElementById('ps-valeur').textContent : '--');
  set('pd-pv-eur', document.getElementById('ps-pv-eur') ? document.getElementById('ps-pv-eur').textContent : '--');
  set('pd-pv-pct', document.getElementById('ps-pv-pct') ? document.getElementById('ps-pv-pct').textContent : '--');
  set('pd-best',  document.getElementById('ps-best')  ? document.getElementById('ps-best').textContent  : '--');
  set('pd-worst', document.getElementById('ps-worst') ? document.getElementById('ps-worst').textContent : '--');
};
}
</script>
</body>
</html>
